{% extends "adminbase.html" %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/offer/offer.css' %}">
{% endblock extra_css %}

{% block content %}
<div class="offers-page-container">
    <div class="offers-card">

        <div class="offers-sticky-header">
            <div class="header-top">
                <div class="titles">
                    <h1>Offers & Promotions</h1>
                    <p>Manage discounts and promotional offers</p>
                </div>
                <div class="card-header-main">
                    <a href="{% url 'manage_offer_view' %}" class="create-offer-link">
                        <button type="button" class="create-offer-btn">
                            <i class="fa-solid fa-plus"></i>
                            <span>Create Offer</span>
                        </button>
                    </a>
                </div>
            </div>

            <div class="selection_area">
                <button class="tab-btn active" onclick="switchTab(event, 'all')">All Offers</button>
                <button class="tab-btn" onclick="switchTab(event, 'products')">Products</button>
                <button class="tab-btn" onclick="switchTab(event, 'categories')">Categories</button>
            </div>
        </div>

        <!-- TAB 1: ALL OFFERS -->
        <div id="tab-all" class="tab-content active">
            <div class="table-responsive">
                <table class="offers-table">
                    <thead>
                        <tr>
                            <th>Offer Name</th>
                            <th>Description</th>
                            <th>Type</th>
                            <th>Discount</th>
                            <th>Valid Period</th>
                            <th>Status</th>
                            <th>Display</th>
                            <th class="text-center">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for offer in offers %}
                        <tr>
                            <td><strong>{{ offer.name }}</strong></td>
                            <td class="truncate-text">{{ offer.description }}</td>
                            <td>{{ offer.get_offer_type_display }}</td>
                            <td>
                                {% if offer.discount_type == "percentage" %}
                                    <span class="discount-pill">{{ offer.discount_value }}% OFF</span>
                                {% else %}
                                    <span class="discount-pill">₹{{ offer.discount_value }} OFF</span>
                                {% endif %}
                            </td>
                            <td>{{ offer.start_date|date:"Y-m-d" }} → 
                                {% if offer.end_date %}
                                    {{ offer.end_date|date:"Y-m-d" }}
                                {% else %}
                                     Not Fixed
                                {% endif %}</td>
                            <td>
                                <span class="status-badge {% if offer.active %}active{% else %}inactive{% endif %}">
                                    {{ offer.active|yesno:"Active,Inactive" }}
                                </span>
                            </td>
                            <td>
                                <span class="status-badge {% if offer.display_home %}active{% else %}inactive{% endif %}">
                                    {{ offer.display_home|yesno:"Home,Hidden" }}
                                </span>
                            </td>
                            <td class="action-buttons text-center">
                                <a href="{% url 'Offer_detailed_view' offer.id %}" class="action-btn view-btn"><i class="fa-solid fa-file-lines"></i></a>
                                <a href="{% url 'edit_offer_view' offer.pk %}" class="action-btn edit-btn"><i class="fa-solid fa-pen-to-square"></i></a>
                                <a href="#" class="action-btn delete-btn" onclick="showDeleteModal(event, {{ offer.id }})"><i class="fa-solid fa-trash-can"></i></a>
                            </td>
                        </tr>
                        {% empty %}
                        <tr><td colspan="9" class="text-center">No offers available.</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- TAB 2: PRODUCTS -->
        <div id="tab-products" class="tab-content">
            <div class="variant-list-container">
                {% for offer in products_offers %}
                
                <div class="product-group">
                    <div class="group-header" onclick="toggleAccordion(this)">
                        <div class="prod-meta">
                            <span>{{offer.id}}</span>
                        </div>
                        <div class="prod-main">
                            <div class="prod-info"><strong>{{ offer.name }}</strong></div>
                        </div>
                        <div class="prod-meta">
                            {% if offer.active %}
                                Active Offer
                            {% else %}
                                Ended Offer
                            {% endif %}
                        </div>
                        <div class="prod-status active">
                            {% if offer.active %}
                                Active
                            {% else %}
                                Ended
                            {% endif %}</div>
                        <button class="view-details-btn">
                            <a href="{% url "Offer_detailed_view" offer.id %}">View</a>
                        </button>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- TAB 3: CATEGORIES -->
        <div id="tab-categories" class="tab-content">
            <div class="variant-list-container">
                {% for offer in category_offers %}
                    {% for cat in offer.categories.all %}
                    <div class="product-group">
                        <div class="group-header" onclick="toggleAccordion(this)">
                            <div class="prod-main">
                                <i class="fa-solid fa-chevron-down accordion-icon"></i>
                                <div class="prod-info"><strong>{{ cat.name }}</strong></div>
                            </div>
                            <div class="prod-meta">Category Offer</div>
                            <div class="prod-meta"><strong>{{ cat.products.count }} products</strong></div>
                            <div class="prod-status active">Active</div>
                            <button class="view-details-btn">
                                <a href="{% url "edit_offer_view" offer.id %}">Manage</a>
                            </button>
                        </div>
                        <div class="product-offers-list">
                            <div class="offer-item-row">
                                <span class="offer-benefit">₹{{ offer.discount_value }} OFF</span>
                                <span class="offer-validity">Ends: {% if offer.end_date %}
                                        {{ offer.end_date|date:"Y-m-d" }}
                                        {% else %}
                                        infinity
                                    {% endif %}</span>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                {% endfor %}
            </div>
        </div>

    </div>
</div>

<!-- DELETE MODAL -->
<div id="deleteModal" class="modal-overlay">
    <div class="modal-content">
        <h3>Confirm Deletion</h3>
        <p>Are you sure you want to delete this offer?</p>
        <div class="modal-actions">
            <button onclick="closeModal()" class="btn-secondary">Cancel</button>
            <button id="confirmDeleteBtn" class="btn-danger">Delete Permanently</button>
        </div>
    </div>
</div>
{% endblock content %}

{% block extraJs %}
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>

<script>

// -------- Tab Logic --------
function switchTab(event, tabName) {
    $('.tab-btn').removeClass('active');
    $(event.currentTarget).addClass('active');
    $('.tab-content').removeClass('active');
    $('#tab-' + tabName).addClass('active');
}

// -------- Accordion --------
function toggleAccordion(header) {
    const group = $(header).closest('.product-group');
    group.toggleClass('is-open');
    group.find('.product-offers-list').slideToggle(250);
}

// -------- DELETE OFFER --------
function getCookie(name) {
    const cookies = document.cookie.split(';');
    for (const cookie of cookies) {
        const trimmed = cookie.trim();
        if (trimmed.startsWith(name + '=')) {
            return decodeURIComponent(trimmed.split('=')[1]);
        }
    }
    return null;
}

function closeModal() {
    $('#deleteModal').fadeOut(200);
}

function showDeleteModal(e, id) {
    e.preventDefault();
    $('#deleteModal').css('display', 'flex').hide().fadeIn(200);
    $('#confirmDeleteBtn').off('click').on('click', () => executeDelete(id));
}

function executeDelete(id) {
    const btn = $('#confirmDeleteBtn');
    btn.prop('disabled', true).html('<i class="fa fa-spinner fa-spin"></i>');

    axios.post('{% url "Offer_delete_view" %}', { id }, {
        headers: {
            "X-CSRFToken": getCookie("csrftoken"),
            "Content-Type": "application/json",
        }
    })
    .then(res => {
        toastr.success(res.data.message || "Deleted!");
        setTimeout(() => location.reload(), 900);
    })
    .catch(() => {
        toastr.error("Delete failed!");
        btn.prop('disabled', false).text('Delete Permanently');
    })
    .finally(closeModal);
}

$(window).on('click', (e) => {
    if ($(e.target).is('#deleteModal')) closeModal();
});
</script>
{% endblock extraJs %}
