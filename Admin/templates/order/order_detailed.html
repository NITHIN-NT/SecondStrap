{% extends 'adminbase.html' %} 
{% load static %}

{% block extra_css %}
<link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
<style>

/* --- 1. GENERAL LAYOUT --- */
.admin-od-wrapper {
    padding: 30px;
    background-color: #f8fafc; /* Slate-50 */
    min-height: 100vh;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
    color: #334155;
}

.admin-od-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 24px;
}

.admin-od-header h1 {
    margin: 8px 0 4px 0;
    font-size: 28px;
    font-weight: 700;
    color: #0f172a;
}

.admin-od-grid {
    display: grid;
    grid-template-columns: 1fr 380px; /* Flexible left, Fixed right */
    gap: 24px;
    align-items: start;
}

@media (max-width: 1024px) {
    .admin-od-grid {
        grid-template-columns: 1fr;
    }
}

/* --- 2. CARD STYLING --- */
.card {
    background: #ffffff;
    border-radius: 12px;
    box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px -1px rgba(0, 0, 0, 0.1);
    padding: 24px;
    margin-bottom: 24px;
    border: 1px solid #e2e8f0;
}

.card-title {
    font-size: 16px;
    font-weight: 600;
    color: #0f172a;
    margin-bottom: 20px;
    padding-bottom: 12px;
    border-bottom: 1px solid #e2e8f0;
    display: flex;
    align-items: center;
    gap: 8px;
}

/* --- 3. TABLE STYLING --- */
.admin-table {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0;
}

.admin-table th {
    text-align: left;
    color: #64748b;
    font-size: 12px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    font-weight: 600;
    padding-bottom: 12px;
    border-bottom: 2px solid #e2e8f0;
}

.admin-table td {
    padding: 16px 0;
    border-bottom: 1px solid #f1f5f9;
    vertical-align: middle;
    font-size: 14px;
}

.admin-table tr:last-child td {
    border-bottom: none;
}

.item-flex {
    display: flex;
    align-items: center;
    gap: 16px;
}

.product-thumb {
    width: 56px;
    height: 56px;
    object-fit: cover;
    border-radius: 6px;
    border: 1px solid #e2e8f0;
    background-color: #f1f5f9;
}

/* --- 4. RETURN ACTION BUTTONS (INDIVIDUAL) --- */
.action-btn-wrapper {
    display: flex;
    gap: 8px;
    justify-content: flex-end;
    margin-top: 4px;
}

.btn-action-sm {
    padding: 6px 10px;
    border-radius: 6px;
    font-size: 11px;
    font-weight: 600;
    cursor: pointer;
    border: 1px solid transparent;
    display: inline-flex;
    align-items: center;
    gap: 4px;
    transition: all 0.2s;
    text-decoration: none;
}

/* Approve (Green) */
.btn-approve-item {
    background-color: #dcfce7;
    color: #166534;
    border-color: #bbf7d0;
}
.btn-approve-item:hover {
    background-color: #166534;
    color: white;
}

/* Reject (Red) */
.btn-reject-item {
    background-color: #fee2e2;
    color: #991b1b;
    border-color: #fecaca;
}
.btn-reject-item:hover {
    background-color: #991b1b;
    color: white;
}

.return-badge {
    font-size: 10px;
    padding: 2px 6px;
    background: #fff7ed;
    color: #c2410c;
    border: 1px solid #ffedd5;
    border-radius: 4px;
    margin-bottom: 4px;
    display: inline-block;
}

/* --- 5. BULK ACTION SIDEBAR --- */
.bulk-return-wrapper {
    margin-top: 16px;
    padding-top: 16px;
    border-top: 1px dashed #cbd5e1;
}

.bulk-btn-group {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.btn-bulk {
    width: 100%;
    padding: 10px;
    border-radius: 6px;
    font-weight: 600;
    font-size: 13px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
    transition: all 0.2s;
    border: 1px solid transparent;
}

.btn-bulk-approve {
    background-color: #f0fdf4;
    color: #15803d;
    border-color: #15803d;
}
.btn-bulk-approve:hover {
    background-color: #15803d;
    color: white;
}

.btn-bulk-reject {
    background-color: #fef2f2;
    color: #b91c1c;
    border-color: #b91c1c;
}
.btn-bulk-reject:hover {
    background-color: #b91c1c;
    color: white;
}

/* --- 6. GENERAL UTILS --- */
.info-row {
    display: flex;
    justify-content: space-between;
    margin-bottom: 12px;
    font-size: 14px;
}
.info-label { color: #64748b; }
.info-val { font-weight: 500; color: #0f172a; }
.total-row { border-top: 2px solid #e2e8f0; padding-top: 16px; margin-top: 16px; font-size: 18px; font-weight: 700; }

.action-group { margin-bottom: 16px; }
.action-label { display: block; font-size: 13px; font-weight: 500; color: #475569; margin-bottom: 6px; }

.form-select {
    width: 100%;
    padding: 10px 12px;
    border: 1px solid #cbd5e1;
    border-radius: 6px;
    background-color: #f8fafc;
    font-size: 14px;
    color: #334155;
    appearance: none;
    background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23334155' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
    background-repeat: no-repeat;
    background-position: right 10px center;
    background-size: 16px;
}

.btn-update {
    width: 100%;
    background-color: #0f172a;
    color: white;
    padding: 12px;
    border: none;
    border-radius: 6px;
    font-weight: 600;
    cursor: pointer;
    margin-top: 8px;
}
.btn-update:hover { background-color: #334155; }

.badge { display: inline-block; padding: 6px 12px; border-radius: 9999px; font-size: 12px; font-weight: 700; text-transform: uppercase; }
.badge-success { background: #dcfce7; color: #15803d; }
.badge-danger { background: #fee2e2; color: #b91c1c; }
.badge-info { background: #dbeafe; color: #1d4ed8; }
.badge-warning { background: #fef3c7; color: #b45309; }

a.back-link { display: inline-flex; align-items: center; gap: 4px; color: #64748b; font-weight: 500; text-decoration: none; }
a.back-link:hover { color: #0f172a; }

</style>
{% endblock extra_css %}

{% block content %}
<div class="admin-od-wrapper">
    
    <div class="admin-od-header">
        <div>
            <a href="{% url 'Admin_order' %}" class="back-link">
                <i class='bx bx-arrow-back'></i> Back to List
            </a>
            <h1 style="margin-top: 5px; font-size: 24px;">Order #{{ order.order_id }}</h1>
            <span style="color: #666; font-size: 14px;">Placed on {{ order.created_at }}</span>
        </div>
        <div>
            {% if order.order_status == 'delivered' %}
                <span class="badge badge-success">DELIVERED</span>
            {% elif order.order_status == 'cancelled' %}
                <span class="badge badge-danger">CANCELLED</span>
            {% else %}
                <span class="badge badge-info">{{ order.get_order_status_display|upper }}</span>
            {% endif %}
        </div>
    </div>

    <div class="admin-od-grid">
        
        <div class="col-left">
            <div class="card">
                <h3 class="card-title">Order Items</h3>
                <table class="admin-table">
                    <thead>
                        <tr>
                            <th>Product</th>
                            <th>Unit Price</th>
                            <th>Total</th>
                            <th style="text-align: right;">Return Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in order.items.all %}
                        <tr>
                            <td>
                                <div class="item-flex">
                                    {% if item.variant.product.image %}
                                        <img src="{{ item.variant.product.image.url }}" class="product-thumb">
                                    {% else %}
                                        <div class="product-thumb" style="background: #eee;"></div>
                                    {% endif %}
                                    <div>
                                        <div style="font-weight: 500;">{{ item.product_name }}</div>
                                        <div style="font-size: 12px; color: #666;">
                                            Size: {{ item.variant.size }} | x{{ item.quantity }}
                                        </div>
                                    </div>
                                </div>
                            </td>
                            <td>₹{{ item.price_at_purchase }}</td>
                            <td>₹{{ item.get_total_price }}</td>
                            
                            <td style="text-align: right;">
                                {% if item.status == 'return_requested' %}
                                    
                                    <div style="display: flex; flex-direction: column; align-items: flex-end;">
                                        <span class="return-badge">Request Pending</span>
                                        
                                        <div class="action-btn-wrapper">
                                            <button class="btn-action-sm btn-reject-item" 
                                                    onclick="handleItemReturn('{{ item.id }}', 'reject')"
                                                    title="Reject Request">
                                                <i class='bx bx-x'></i> Reject
                                            </button>

                                            <button class="btn-action-sm btn-approve-item" 
                                                    onclick="handleItemReturn('{{ item.id }}', 'approve')"
                                                    title="Approve Return">
                                                <i class='bx bx-check'></i> Approve
                                            </button>
                                        </div>
                                    </div>

                                {% elif item.status == 'returned' %}
                                    <span class="badge badge-success">Returned</span>
                                {% elif item.status == 'return_rejected' %}
                                    <span class="badge badge-danger">Return Rejected</span>
                                {% else %}
                                    <span style="color: #cbd5e1;">-</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <div class="card">
                <h3 class="card-title">Order Financials</h3>
                <div class="info-row">
                    <span class="info-label">Subtotal</span>
                    <span class="info-val">₹{{ order.total_price }}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Shipping</span>
                    <span class="info-val">₹49.00</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Tax</span>
                    <span class="info-val">₹18.00</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Discount</span>
                    <span class="info-val" style="color: green;">-₹{{ order.discount_amount }}</span>
                </div>
                <div class="info-row total-row">
                    <span class="info-label">Grand Total</span>
                    <span class="info-val">₹{{ order.final_price }}</span>
                </div>
            </div>
        </div>

        <div class="col-right">
            
            <div class="card" style="border-left: 4px solid #0f172a;">
                <h3 class="card-title"><i class='bx bx-slider-alt'></i> Manage Order</h3>
                
                <form id="orderStatusForm" method="POST" action="{% url 'order_status_update' order.order_id %}">
                    {% csrf_token %}
                    <div class="action-group">
                        <label class="action-label">Order Status</label>
                        <select name="order_status" class="form-select">
                            {% for key, label in order_status_choices %}
                                <option value="{{ key }}" {% if order.order_status == key %}selected{% endif %}>{{ label }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="action-group">
                        <label class="action-label">Payment Status</label>
                        <select name="payment_status" class="form-select">
                            {% for key, label in payment_status_choices %}
                                <option value="{{ key }}" {% if order.payment_status == key %}selected{% endif %}>{{ label }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <button type="submit" class="btn-update">Update Status</button>
                </form>

                {% if has_pending_returns %} 
                <div class="bulk-return-wrapper">
                    <label class="action-label">Pending Returns</label>
                    <p style="font-size: 12px; color: #64748b; margin-bottom: 12px; line-height: 1.4;">
                        Manage all pending requests at once.
                    </p>
                    
                    <div class="bulk-btn-group">
                        <button type="button" class="btn-bulk btn-bulk-approve" 
                                onclick="handleBulkReturn('{{ order.order_id }}', 'approve')">
                            <i class='bx bx-check-double'></i> Approve All Returns
                        </button>
                        
                        <button type="button" class="btn-bulk btn-bulk-reject" 
                                onclick="handleBulkReturn('{{ order.order_id }}', 'reject')">
                            <i class='bx bx-x-circle'></i> Reject All Requests
                        </button>
                    </div>
                </div>
                {% endif %}
            </div>

            <div class="card">
                <h3 class="card-title">Customer</h3>
                <div style="display: flex; align-items: center; gap: 10px;">
                    {% if order.user.profile %}
                        <img src="{{ order.user.profile }}" style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover; border: 2px solid #e5e7eb;">
                    {% else %}
                        <div style="width: 40px; height: 40px; background: #f3f4f6; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 2px solid #e5e7eb;">
                            <i class='bx bx-user' style="font-size: 20px; color: #6b7280;"></i>
                        </div>
                    {% endif %}
                    <div>
                        <div style="font-weight: 600;">{{ order.user.first_name }}</div>
                        <div style="font-size: 13px; color: #666;">{{ order.user.email }}</div>
                    </div>
                </div>
            </div>

            <div class="card">
                <h3 class="card-title">Shipping Address</h3>
                <p style="font-size: 14px; line-height: 1.5; color: #444;">
                    <strong>{{ order.shipping_address_name }}</strong><br>
                    {{ order.shipping_address_line_1 }}<br>
                    {{ order.shipping_city }} - {{ order.shipping_pincode }}<br>
                    {{ order.shipping_state }}<br>
                    <span style="color: #666; font-size: 13px;">Phone: {{ order.shipping_phone }}</span>
                </p>
            </div>

        </div>
    </div>
</div>
{% endblock content %}

{% block extraJs %}
<script>
    // 1. Helper: Get CSRF Token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // 2. Handle Individual Item (Approve OR Reject)
    function handleItemReturn(itemId, actionType) {
        let confirmMsg = actionType === 'approve' ? 'Approve return?' : 'Reject return request?';
        if(!confirm(confirmMsg)) return;

        // Ensure this URL matches your backend urls.py
        // e.g., path('manage-return-item/<int:item_id>/', views.manage_return_item, ...)
        const url = `/admin_panel/manage-return-item/${itemId}/`; 
        const csrftoken = getCookie('csrftoken');

        fetch(url, {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrftoken,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ 'action': actionType }) 
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                toastr.success(`Return ${actionType}ed successfully`);
                setTimeout(() => location.reload(), 1500);
            } else {
                toastr.error(data.message || 'Error updating item');
            }
        })
        .catch(err => {
            console.error(err);
            toastr.error('Network error');
        });
    }

    // 3. Handle Bulk Actions (Approve All OR Reject All)
    function handleBulkReturn(orderId, actionType) {
        let confirmMsg = actionType === 'approve' 
            ? 'Approve ALL pending returns?' 
            : 'Reject ALL pending return requests?';
            
        if(!confirm(confirmMsg)) return;

        // Ensure this URL matches your backend urls.py
        // e.g., path('manage-return-all/<int:order_id>/', views.manage_return_all, ...)
        const url = `/admin_panel/manage-return-all/${orderId}/`; 
        const csrftoken = getCookie('csrftoken');

        fetch(url, {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrftoken,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ 'action': actionType })
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                toastr.success(`All returns ${actionType}ed successfully`);
                setTimeout(() => location.reload(), 1500);
            } else {
                toastr.error(data.message || 'Error processing bulk action');
            }
        })
        .catch(err => {
            console.error(err);
            toastr.error('Network error');
        });
    }

    // 4. On Load: Toastr Config & Status Form
    document.addEventListener('DOMContentLoaded', function() {
        
        // Toastr Defaults
        if (typeof toastr !== 'undefined') {
            toastr.options = {
                "closeButton": true,
                "progressBar": true,
                "positionClass": "toast-top-right",
                "timeOut": "3000"
            };
        }

        // Standard Order Status Form Listener
        const statusForm = document.getElementById('orderStatusForm');

        if (statusForm) {
            statusForm.addEventListener('submit', function(e) {
                e.preventDefault();

                const formData = new FormData(this);
                const actionUrl = this.getAttribute('action');
                
                const submitBtn = this.querySelector('button[type="submit"]');
                const originalBtnText = submitBtn.innerText;
                submitBtn.innerText = 'Updating...';
                submitBtn.disabled = true;

                fetch(actionUrl, {
                    method: 'POST',
                    body: formData,
                    headers: { 'X-Requested-With': 'XMLHttpRequest' }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        toastr.success(data.message || 'Status updated successfully');
                        setTimeout(() => { location.reload(); }, 2000);
                    } else {
                        toastr.error(data.message || 'Something went wrong');
                        submitBtn.innerText = originalBtnText;
                        submitBtn.disabled = false;
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    toastr.error('A network error occurred');
                    submitBtn.innerText = originalBtnText;
                    submitBtn.disabled = false;
                });
            });
        }
    });
</script>
{% endblock extraJs %}