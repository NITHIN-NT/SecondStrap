{% extends 'adminbase.html' %} 
{% load static %}

{% block extra_css %}
<link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>

<style>
    .admin-od-wrapper {
    padding: 30px;
    background-color: #f8fafc;
    min-height: 100vh;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
    color: #334155;
}

.admin-od-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 24px;
}

.admin-od-header h1 {
    margin: 8px 0 4px 0;
    font-size: 28px;
    font-weight: 700;
    color: #0f172a;
}

.admin-od-grid {
    display: grid;
    grid-template-columns: 1fr 380px;
    /* Flexible left, Fixed right */
    gap: 24px;
    align-items: start;
}

@media (max-width: 1024px) {
    .admin-od-grid {
        grid-template-columns: 1fr;
    }
}

/* --- 2. CARD STYLING --- */
.card {
    background: #ffffff;
    border-radius: 12px;
    box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px -1px rgba(0, 0, 0, 0.1);
    padding: 24px;
    margin-bottom: 24px;
    border: 1px solid #e2e8f0;
}

.card-title {
    font-size: 16px;
    font-weight: 600;
    color: #0f172a;
    margin-bottom: 20px;
    padding-bottom: 12px;
    border-bottom: 1px solid #e2e8f0;
    display: flex;
    align-items: center;
    gap: 8px;
}

/* --- 3. TABLE STYLING --- */
.admin-table {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0;
}

.admin-table th {
    text-align: left;
    color: #64748b;
    font-size: 12px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    font-weight: 600;
    padding-bottom: 12px;
    border-bottom: 2px solid #e2e8f0;
}

.admin-table td {
    padding: 16px 0;
    border-bottom: 1px solid #f1f5f9;
    vertical-align: middle;
    font-size: 14px;
}

.admin-table tr:last-child td {
    border-bottom: none;
}

.item-flex {
    display: flex;
    align-items: center;
    gap: 16px;
}

.product-thumb {
    width: 56px;
    height: 56px;
    object-fit: cover;
    border-radius: 6px;
    border: 1px solid #e2e8f0;
    background-color: #f1f5f9;
}

/* --- 4. ACTION BUTTONS --- */
.action-btn-wrapper {
    display: flex;
    gap: 8px;
    justify-content: flex-end;
    align-items: center;
    margin-top: 4px;
}

.btn-action-sm {
    padding: 6px 12px;
    border-radius: 6px;
    font-size: 11px;
    font-weight: 600;
    cursor: pointer;
    border: 1px solid transparent;
    display: inline-flex;
    align-items: center;
    gap: 6px;
    transition: all 0.2s;
    text-decoration: none;
}

/* Approve (Green) */
.btn-approve-item {
    background-color: #dcfce7;
    color: #166534;
    border-color: #bbf7d0;
}

.btn-approve-item:hover {
    background-color: #166534;
    color: white;
}

/* Reject (Red) */
.btn-reject-item {
    background-color: #fee2e2;
    color: #991b1b;
    border-color: #fecaca;
}

.btn-reject-item:hover {
    background-color: #991b1b;
    color: white;
}

/* NEW: Received/Returned (Blue) */
.btn-received-item {
    background-color: #e0f2fe;
    color: #075985;
    border-color: #bae6fd;
}

.btn-received-item:hover {
    background-color: #0284c7;
    color: white;
}

.return-badge {
    font-size: 10px;
    padding: 2px 6px;
    background: #fff7ed;
    color: #c2410c;
    border: 1px solid #ffedd5;
    border-radius: 4px;
    margin-bottom: 4px;
    display: inline-block;
}

/* --- 5. GENERAL UTILS --- */
.info-row {
    display: flex;
    justify-content: space-between;
    margin-bottom: 12px;
    font-size: 14px;
}

.info-label {
    color: #64748b;
}

.info-val {
    font-weight: 500;
    color: #0f172a;
}

.total-row {
    border-top: 2px solid #e2e8f0;
    padding-top: 16px;
    margin-top: 16px;
    font-size: 18px;
    font-weight: 700;
}

.action-group {
    margin-bottom: 16px;
}

.action-label {
    display: block;
    font-size: 13px;
    font-weight: 500;
    color: #475569;
    margin-bottom: 6px;
}

.form-select {
    width: 100%;
    padding: 10px 12px;
    border: 1px solid #cbd5e1;
    border-radius: 6px;
    background-color: #f8fafc;
    font-size: 14px;
    color: #334155;
    appearance: none;
    background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23334155' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
    background-repeat: no-repeat;
    background-position: right 10px center;
    background-size: 16px;
}

.btn-update {
    width: 100%;
    background-color: #0f172a;
    color: white;
    padding: 12px;
    border: none;
    border-radius: 6px;
    font-weight: 600;
    cursor: pointer;
    margin-top: 8px;
}

.btn-update:hover {
    background-color: #334155;
}

.badge {
    display: inline-block;
    padding: 6px 12px;
    border-radius: 9999px;
    font-size: 12px;
    font-weight: 700;
    text-transform: uppercase;
}

.badge-success {
    background: #dcfce7;
    color: #15803d;
}

.badge-danger {
    background: #fee2e2;
    color: #b91c1c;
}

.badge-info {
    background: #dbeafe;
    color: #1d4ed8;
}

.badge-warning {
    background: #fef3c7;
    color: #b45309;
}

.badge-secondary {
    background: #f1f5f9;
    color: #475569;
}

/* Tooltip */
.note-tooltip-wrapper { position: relative; display: inline-block; margin-left: 8px; }
.note-trigger-icon { font-size: 20px; color: #64748b; cursor: pointer; vertical-align: middle; }
.note-trigger-icon:hover { color: #0f172a; }
.note-tooltip-box { visibility: hidden; opacity: 0; position: absolute; bottom: 130%; right: -10px; width: 220px; background-color: #334155; color: #fff; text-align: left; padding: 10px 12px; border-radius: 6px; font-size: 12px; line-height: 1.4; z-index: 100; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); transition: opacity 0.2s, visibility 0.2s; }
.note-tooltip-box::after { content: ""; position: absolute; top: 100%; right: 14px; margin-left: -5px; border-width: 5px; border-style: solid; border-color: #334155 transparent transparent transparent; }
.note-tooltip-wrapper:hover .note-tooltip-box { visibility: visible; opacity: 1; }

</style>
{% endblock extra_css %}
{% block content %}
<div class="admin-od-wrapper">
    
    <div class="admin-od-header">
        <div>
            <h1 style="margin-top: 5px; font-size: 24px;">Order #{{ order.order_id }}</h1>
            <span style="color: #666; font-size: 14px;">Placed on {{ order.created_at }}</span>
        </div>
        <div>
            {% if order.order_status == 'delivered' %}
                <span class="badge badge-success">DELIVERED</span>
            {% elif order.order_status == 'cancelled' %}
                <span class="badge badge-danger">CANCELLED</span>
            {% else %}
                <span class="badge badge-info">{{ order.get_order_status_display|upper }}</span>
            {% endif %}
        </div>
    </div>

    <div class="admin-od-grid">
        
        <div class="col-left">
            <div class="card">
                <h3 class="card-title">Order Items</h3>
                <table class="admin-table">
                    <thead>
                        <tr>
                            <th>Product</th>
                            <th>Unit Price</th>
                            <th>Total</th>
                            <th style="text-align: right;">Return Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in order.items.all %}
                        <tr>
                            <td>
                                <div class="item-flex">
                                    {% with variant=item.variant %}
                                        {% if variant and variant.product and variant.product.image %}
                                            <img src="{{ variant.product.image.url }}" class="product-thumb">
                                        {% else %}
                                            <div class="product-thumb" style="background: #eee;"></div>
                                        {% endif %}
                                        <div>
                                            <div style="font-weight: 500;">{{ item.product_name }}</div>
                                            <div style="font-size: 12px; color: #666;">
                                                Size: {% if variant %}{{ variant.size }}{% else %}-{% endif %} | x{{ item.quantity }}
                                            </div>
                                        </div>
                                    {% endwith %}
                                </div>
                            </td>
                            <td>₹{{ item.price_at_purchase }}</td>
                            <td>₹{{ item.get_total_price }}</td>
                            
                            <td style="text-align: right;">
                                
                                {% with ret=item.return_item.all|first %} 

                                    {% if item.status == 'return_requested' %}
                                        <div style="display: flex; flex-direction: column; align-items: flex-end;">
                                            <span class="return-badge">Request Pending</span>
                                            <div class="action-btn-wrapper">
                                                <button class="btn-action-sm btn-reject-item" 
                                                        onclick="handleItemReturn('{{ item.id }}','{{ order.order_id }}', 'reject')"
                                                        title="Reject Request">
                                                    <i class='bx bx-x'></i> Reject
                                                </button>
                                                <button class="btn-action-sm btn-approve-item" 
                                                        onclick="handleItemReturn('{{ item.id }}','{{ order.order_id }}', 'approve')"
                                                        title="Approve Return">
                                                    <i class='bx bx-check'></i> Approve
                                                </button>
                                            </div>
                                        </div>

                                    {% elif item.status == 'return_approved' %}
                                        <div style="display: flex; flex-direction: column; align-items: flex-end;">
                                            <span class="badge badge-warning" style="font-size: 10px; margin-bottom: 4px;">Awaiting Return</span>
                                            <div class="action-btn-wrapper">
                                                <button class="btn-action-sm btn-received-item" 
                                                        onclick="handleItemReturn('{{ item.id }}','{{ order.order_id }}', 'returned')"
                                                        title="Mark as Received/Returned">
                                                    <i class='bx bx-box'></i> Mark Received
                                                </button>
                                            </div>
                                        </div>

                                    {% elif item.status == 'returned' %}
                                        <span class="badge badge-success">Returned</span>
                                    {% elif item.status == 'return_rejected' %}
                                        <span class="badge badge-danger">Return Rejected</span>
                                    {% else %}
                                        <span class="badge badge-secondary" style="opacity: 0.5;">None</span>
                                    {% endif %}

                                    {% if ret and ret.return_reason or ret.return_note %}
                                        <div class="note-tooltip-wrapper">
                                            
                                            {% if ret.return_note %}
                                                <i class='bx bx-notepad note-trigger-icon' style="color: #3b82f6;"></i>
                                            {% else %}
                                                <i class='bx bx-info-circle note-trigger-icon'></i>
                                            {% endif %}
                                            
                                            <div class="note-tooltip-box">
                                                {% if ret.return_reason %}
                                                    <div style="margin-bottom: 6px;">
                                                        <strong style="color: #94a3b8; font-size: 10px; text-transform: uppercase;">User Reason:</strong><br>
                                                        {{ ret.return_reason }}
                                                    </div>
                                                {% endif %}

                                                {% if ret.return_note %}
                                                    {% if ret.return_reason %}<hr style="border-color: #475569; margin: 4px 0;">{% endif %}
                                                    <div>
                                                        <strong style="color: #94a3b8; font-size: 10px; text-transform: uppercase;">Note:</strong><br>
                                                        <span style="color: #e2e8f0; font-style: italic;">"{{ ret.return_note }}"</span>
                                                    </div>
                                                {% endif %}
                                            </div>
                                        </div>
                                    {% endif %}

                                {% endwith %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <div class="card">
                <h3 class="card-title">Order Financials</h3>
                <div class="info-row">
                    <span class="info-label">Subtotal</span>
                    <span class="info-val">₹{{ order.total_price }}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Shipping</span>
                    <span class="info-val">₹49.00</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Tax</span>
                    <span class="info-val">₹18.00</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Discount</span>
                    <span class="info-val" style="color: green;">-₹{{ order.discount_amount }}</span>
                </div>
                <div class="info-row total-row">
                    <span class="info-label">Grand Total</span>
                    <span class="info-val">₹{{ order.final_price }}</span>
                </div>
            </div>
        </div>

        <div class="col-right">
            <div class="card" style="border-left: 4px solid #0f172a;">
                <h3 class="card-title"><i class='bx bx-slider-alt'></i> Manage Order</h3>
                
                <form id="orderStatusForm" method="POST" action="{% url 'order_status_update' order.order_id %}">
                    {% csrf_token %}
                    <div class="action-group">
                        <label class="action-label">Order Status</label>
                        <select name="order_status" class="form-select">
                            {% for key, label in order_status_choices %}
                                <option value="{{ key }}" {% if order.order_status == key %}selected{% endif %}>{{ label }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="action-group">
                        <label class="action-label">Payment Status</label>
                        <select name="payment_status" class="form-select">
                            {% for key, label in payment_status_choices %}
                                <option value="{{ key }}" {% if order.payment_status == key %}selected{% endif %}>{{ label }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <button type="submit" class="btn-update">Update Status</button>
                </form>

            </div>

            <div class="card">
                <h3 class="card-title">Customer</h3>
                {% if order.user %}
                    <div style="display: flex; align-items: center; gap: 10px;">
                        {% if order.user.profile %}
                            <img src="{{ order.user.profile }}" style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover; border: 2px solid #e5e7eb;">
                        {% else %}
                            <div style="width: 40px; height: 40px; background: #f3f4f6; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 2px solid #e5e7eb;">
                                <i class='bx bx-user' style="font-size: 20px; color: #6b7280;"></i>
                            </div>
                        {% endif %}
                        <div>
                            <div style="font-weight: 600;">{{ order.user.first_name }}</div>
                            <div style="font-size: 13px; color: #666;">{{ order.user.email }}</div>
                        </div>
                    </div>
                {% else %}
                    <p style="font-size: 14px; color: #666;">Customer information not available.</p>
                {% endif %}
            </div>

            <div class="card">
                <h3 class="card-title">Shipping Address</h3>
                <p style="font-size: 14px; line-height: 1.5; color: #444;">
                    <strong>{{ order.shipping_address_name }}</strong><br>
                    {{ order.shipping_address_line_1 }}<br>
                    {{ order.shipping_city }} - {{ order.shipping_pincode }}<br>
                    {{ order.shipping_state }}<br>
                    <span style="color: #666; font-size: 13px;">Phone: {{ order.shipping_phone }}</span>
                </p>
            </div>

        </div>
    </div>
</div>
{% endblock content %}

{% block extraJs %}
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

<script>
    // 1. Toastr Config
    document.addEventListener('DOMContentLoaded', function() {
        if (typeof toastr !== 'undefined') {
            toastr.options = {
                "closeButton": true,
                "progressBar": true,
                "positionClass": "toast-top-right",
                "timeOut": "3000"
            };
        }
    });

    // 2. Helper: Get CSRF Token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    const csrftoken = getCookie('csrftoken');
    axios.defaults.headers.common['X-CSRFToken'] = csrftoken;

    // 3. Handle Individual Item (Approve, Reject, OR Return)
    function handleItemReturn(itemId, OrderId, actionType) {
        
        let confirmMsg = "";
        if (actionType === 'approve') confirmMsg = 'Approve return request?';
        else if (actionType === 'reject') confirmMsg = 'Reject return request?';
        else if (actionType === 'returned') confirmMsg = 'Confirm item has been received and mark as returned?';
        
        if(!confirm(confirmMsg)) return;

        // NOTE: Ensure 'manage_return_request' matches your urls.py name exactly.
        let urlTemplate = "{% url 'manage_return_item' 0 'ORDER_ID_PLACEHOLDER' %}";
        let url = urlTemplate.replace('0', itemId).replace('ORDER_ID_PLACEHOLDER', OrderId);

        axios.post(url, {
            action: actionType
        })
        .then(response => {
            const data = response.data;
            if (data.status === 'success') {
                toastr.success(`Action (${actionType}) completed successfully`);
                setTimeout(() => location.reload(), 1500);
            } else {
                toastr.error(data.message || 'Error updating item');
            }
        })
        .catch(error => {
            console.error(error);
            toastr.error(error.response?.data?.message || 'Network error');
        });
    }

    // 4. Status Form Handler
    document.addEventListener('DOMContentLoaded', function() {
        const statusForm = document.getElementById('orderStatusForm');
        if (statusForm) {
            statusForm.addEventListener('submit', function(e) {
                e.preventDefault();
                const formData = new FormData(this);
                const actionUrl = this.getAttribute('action');
                const submitBtn = this.querySelector('button[type="submit"]');
                const originalBtnText = submitBtn.innerText;
                
                submitBtn.innerText = 'Updating...';
                submitBtn.disabled = true;

                axios.post(actionUrl, formData)
                .then(response => {
                    const data = response.data;
                    if (data.status === 'success') {
                        toastr.success(data.message || 'Status updated successfully');
                        setTimeout(() => { location.reload(); }, 2000);
                    } else {
                        toastr.error(data.message || 'Something went wrong');
                        submitBtn.innerText = originalBtnText;
                        submitBtn.disabled = false;
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    toastr.error(error.response?.data?.message || 'A network error occurred');
                    submitBtn.innerText = originalBtnText;
                    submitBtn.disabled = false;
                });
            });
        }
    });
</script>
{% endblock extraJs %}