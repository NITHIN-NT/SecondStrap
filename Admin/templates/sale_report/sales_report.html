{% extends "adminbase.html" %}
{% load static %}
{% block title %}Sales Report{% endblock %}
{% block extra_css %}
<style>
/* ==== EXISTING CSS (Unchanged) ==== */
:root {
    --card-bg: #ffffff;
    --text-main: #111827;
    --text-muted: #6b7280;
    --border-color: #f3f4f6;
    --green-growth: #10b981;
    --red-decline: #ef4444;
    --panel-bg: #f9fafb;
}

.report-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 2rem; }
.header-title h1 { font-size: 1.875rem; font-weight: 700; color: var(--text-main); }
.header-title p { color: var(--text-muted); font-size: 0.875rem; }
.action-buttons { display: flex; gap: 0.75rem; }
.btn-export, .btn-download { padding: 0.5rem 1rem; border-radius: 0.5rem; font-size: 0.875rem; cursor: pointer; transition: all 0.2s ease; }
.btn-download { background: #0f172a; color: #fff; border: none; }
.btn-download:hover { background: #1e293b; }
.btn-pdf, .btn-excel { background: #000; color: #fff; border: none; display: flex; align-items: center; gap: 0.5rem; }
.btn-clear { padding: 0.5rem 1rem; border-radius: 0.5rem; font-size: 0.875rem; cursor: pointer; background: #fff; color: #6b7280; border: 1px solid #d1d5db; transition: all 0.2s ease; }
.btn-clear:hover:not(:disabled) { background: #f9fafb; border-color: #9ca3af; color: #374151; }
.btn-clear:disabled { opacity: 0.5; cursor: not-allowed; }
.time-period-dropdown { position: relative; display: inline-block; }
.dropdown-content { display: none; position: absolute; background: white; min-width: 200px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); border-radius: 0.5rem; z-index: 100; max-height: 300px; overflow-y: auto; margin-top: 0.5rem; border: 1px solid var(--border-color); }
.dropdown-content.show { display: block; }
.dropdown-item { padding: 0.75rem 1rem; cursor: pointer; font-size: 0.875rem; }
.dropdown-item:hover { background: #f9fafb; }
.dropdown-item.selected { background: #eff6ff; color: #1e40af; font-weight: 600; }
.kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem; margin-bottom: 2.5rem; }
.kpi-card { background: white; padding: 1.5rem; border-radius: 0.75rem; border: 1px solid var(--border-color); }
.kpi-label { font-size: 0.75rem; color: var(--text-muted); margin-bottom: 0.5rem; }
.kpi-value { font-size: 1.5rem; font-weight: 700; }
.time-toggle { display: flex; background: #f3f4f6; padding: 0.25rem; border-radius: 0.5rem; gap: 5px; }
.time-toggle button { border: none; background: transparent; padding: 0.4rem 1rem; cursor: pointer; }
.time-toggle button.active { background: #fff; border-radius: 0.375rem; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
.custom-filter-panel { background: var(--panel-bg); padding: 1.5rem; border-radius: 0.75rem; border: 1px solid var(--border-color); margin: 1.5rem 0; }
.filter-inputs-row { display: flex; flex-wrap: wrap; gap: 1rem; align-items: flex-end; }
.filter-field { display: flex; flex-direction: column; gap: 0.4rem; }
.filter-select, .filter-input { padding: 0.45rem 0.75rem; border-radius: 0.5rem; border: 1px solid #ddd; min-width: 180px; }
.table-container { background: white; border-radius: 0.75rem; border: 1px solid var(--border-color); overflow: hidden; position: relative; }
.sales-table { width: 100%; border-collapse: collapse; }
.sales-table th { background: #f9fafb; padding: 0.75rem 1.5rem; font-size: 0.7rem; text-align: left; }
.sales-table td { padding: 1rem 1.5rem; font-size: 0.875rem; border-bottom: 1px solid var(--border-color); }

/* Pagination Styling */
.pagination-footer { display: flex; justify-content: space-between; align-items: center; padding: 1rem 1.5rem; background: #fff; border-top: 1px solid var(--border-color); }
.pagination-info { font-size: 0.875rem; color: var(--text-muted); }
.pagination-controls { display: flex; gap: 0.5rem; }

.loading-overlay { position: absolute; inset: 0; background: rgba(255,255,255,0.75); display: none; align-items: center; justify-content: center; z-index: 10; }
.loading-overlay.active { display: flex; }
.spinner { width: 40px; height: 40px; border: 3px solid #eee; border-top: 3px solid #0f172a; border-radius: 50%; animation: spin 1s linear infinite; }
@keyframes spin { to { transform: rotate(360deg); } }
</style>
{% endblock %}

{% block content %}
<div class="report-container">

    <header class="report-header">
        <div class="header-title">
            <h1>Sales Report</h1>
            <p>Overview of revenue & order performance</p>
        </div>
        <div class="action-buttons">
            <button class="btn-export btn-pdf"><i class="fa-solid fa-file-pdf"></i> Export PDF</button>
            <button class="btn-export btn-excel"><i class="fa-solid fa-file-excel"></i> Export Excel</button>
        </div>
    </header>

    <div class="kpi-grid">
        <div class="kpi-card">
            <div class="kpi-label">Filtered Revenue</div>
            <div class="kpi-value" id="filteredRevenue">₹{{ filter_sale_total }}</div>
        </div>
        <div class="kpi-card">
            <div class="kpi-label">Filtered Units</div>
            <div class="kpi-value" id="filteredUnits">{{ filter_unit_sold }}</div>
        </div>
        <div class="kpi-card">
            <div class="kpi-label">Filtered Avg Order</div>
            <div class="kpi-value" id="filteredAvg">₹{{ filter_avg_sale|floatformat:2 }}</div>
        </div>
    </div>

    <div class="time-toggle">
        <div class="time-period-dropdown">
            <button class="active" id="monthlyBtn">Monthly</button>
            <div class="dropdown-content" id="monthlyDropdown"></div>
        </div>
        <div class="time-period-dropdown">
            <button id="yearlyBtn">Yearly</button>
            <div class="dropdown-content" id="yearlyDropdown"></div>
        </div>
        <button id="custom-filter-trigger"><i class="fa-solid fa-filter"></i> Custom Filter</button>
    </div>

    <div class="custom-filter-panel" id="filterPanel" style="display:none;">
        <form id="filterForm" class="filter-inputs-row">
            <div class="filter-field">
                <label>Product</label>
                <select name="product" class="filter-select">
                    <option value="">All Products</option>
                    {% for product in products %}<option value="{{ product.id }}">{{ product.name }}</option>{% endfor %}
                </select>
            </div>
            <div class="filter-field"><label>Start Date</label><input type="date" name="start_date" class="filter-input"></div>
            <div class="filter-field"><label>End Date</label><input type="date" name="end_date" class="filter-input"></div>
            <div class="filter-field"><label>Min Units</label><input type="number" name="item_count" class="filter-input" placeholder="e.g. 2"></div>
            <div class="filter-field">
                <label>Status</label>
                <select name="status" class="filter-select">
                    <option value="">All Status</option>
                    {% for key,value in order_status %}<option value="{{ key }}">{{ value }}</option>{% endfor %}
                </select>
            </div>
            <button type="submit" class="btn-download" style="height:38px;">Apply Filters</button>
            <button type="button" id="clearFilter" class="btn-clear" style="height:38px;">Clear</button>
        </form>
    </div>

    <div class="table-container">
        <div class="loading-overlay" id="tableLoading"><div class="spinner"></div></div>
        <table class="sales-table">
            <thead>
                <tr>
                    <th>Date</th><th>Order</th><th>Coupon</th><th>Units</th><th>Revenue</th><th>Status</th><th></th>
                </tr>
            </thead>
            <tbody id="ordersTableBody">{% include "sale_report/_orders_rows.html" %}</tbody>
        </table>

        <div class="pagination-footer" id="paginationWrapper">
            <div class="pagination-info">
                Showing Page <span id="currentPageNum">{{ page_obj.number }}</span> of <span id="totalPageNum">{{ page_obj.paginator.num_pages }}</span>
            </div>
            <div class="pagination-controls">
                <button class="btn-clear page-link-btn" id="prevPage" 
                        {% if page_obj.has_previous %}
                            data-page="{{ page_obj.previous_page_number }}"
                        {% else %}
                            data-page="" disabled
                        {% endif %}>
                    <i class="fa-solid fa-chevron-left"></i> Previous
                </button>
                <button class="btn-clear page-link-btn" id="nextPage" 
                        {% if page_obj.has_next %}
                            data-page="{{ page_obj.next_page_number }}"
                        {% else %}
                            data-page="" disabled
                        {% endif %}>
                    Next <i class="fa-solid fa-chevron-right"></i>
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extraJs %}
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script>
$(document).ready(function () {
    let currentFilters = {}; 

    function populateMonths() {
        const months = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
        const currentMonth = new Date().getMonth();
        const currentYear = new Date().getFullYear();
        let html = '';
        for (let i = 0; i < 12; i++) {
            const monthIndex = (currentMonth - i + 12) % 12;
            const year = currentMonth - i < 0 ? currentYear - 1 : currentYear;
            html += `<div class="dropdown-item" data-month="${monthIndex}" data-year="${year}">${months[monthIndex]} ${year}</div>`;
        }
        $('#monthlyDropdown').html(html);
    }

    function populateYears() {
        const currentYear = new Date().getFullYear();
        let html = '';
        for (let i = 0; i < 5; i++) {
            const year = currentYear - i;
            html += `<div class="dropdown-item" data-year="${year}">${year}</div>`;
        }
        $('#yearlyDropdown').html(html);
    }

    populateMonths();
    populateYears();

    async function fetchReportData(params = {}) {
        $('#tableLoading').addClass('active');
        const finalParams = { ...currentFilters, ...params };

        try {
            const response = await axios.get(window.location.pathname, {
                params: finalParams,
                headers: { 'X-Requested-With': 'XMLHttpRequest' }
            });

            const data = response.data;
            $('#filteredRevenue').text('₹' + data.filter_sale_total);
            $('#filteredUnits').text(data.filter_unit_sold);
            $('#filteredAvg').text('₹' + parseFloat(data.filter_avg_sale).toFixed(2));
            $('#ordersTableBody').html(data.orders_html);
            $('#currentPageNum').text(data.number);
            $('#totalPageNum').text(data.num_pages);
            
            // Correctly update dynamic data attributes
            if(data.has_previous) {
                $('#prevPage').attr('data-page', data.number - 1).prop('disabled', false);
            } else {
                $('#prevPage').attr('data-page', "").prop('disabled', true);
            }

            if(data.has_next) {
                $('#nextPage').attr('data-page', data.number + 1).prop('disabled', false);
            } else {
                $('#nextPage').attr('data-page', "").prop('disabled', true);
            }

            const { page, ...filtersOnly } = finalParams;
            currentFilters = filtersOnly;
        } catch (err) {
            console.error(err);
            alert('Failed to load report data');
        } finally {
            $('#tableLoading').removeClass('active');
        }
    }

    $(document).on('click', '.page-link-btn', function() {
        const pageNum = $(this).attr('data-page');
        if (pageNum && parseInt(pageNum) >= 1) {
            fetchReportData({ page: pageNum });
        }
    });

    $('.dropdown-content').on('click', '.dropdown-item', function() {
        $('.dropdown-item').removeClass('selected');
        $(this).addClass('selected');
        $('.dropdown-content').removeClass('show');
        let params = { page: 1 };
        if ($(this).closest('#monthlyDropdown').length) {
            params.filter_type = 'monthly';
            params.month = $(this).data('month') + 1;
            params.year = $(this).data('year');
        } else {
            params.filter_type = 'yearly';
            params.year = $(this).data('year');
        }
        fetchReportData(params);
    });

    $('#filterForm').on('submit', function (e) {
        e.preventDefault();
        const formData = new FormData(this);
        const params = { page: 1 };
        for (let [key, value] of formData.entries()) { if (value) params[key] = value; }
        fetchReportData(params);
    });

    $('#clearFilter').on('click', function () {
        $('#filterForm')[0].reset();
        currentFilters = {};
        fetchReportData({ page: 1 });
    });

    $('.btn-pdf').on('click', function() {
        const query = new URLSearchParams(currentFilters).toString();
        window.location.href = "{% url 'sales_report_pdf' %}?" + query;
    });

    $('.btn-excel').on('click', function() {
        const query = new URLSearchParams(currentFilters).toString();
        window.location.href = "{% url 'sales_report_excel' %}?" + query;
    });

    $('#monthlyBtn').click(function(e) { e.stopPropagation(); $('.time-toggle button').removeClass('active'); $(this).addClass('active'); $('#yearlyDropdown').removeClass('show'); $('#monthlyDropdown').toggleClass('show'); });
    $('#yearlyBtn').click(function(e) { e.stopPropagation(); $('.time-toggle button').removeClass('active'); $(this).addClass('active'); $('#monthlyDropdown').removeClass('show'); $('#yearlyDropdown').toggleClass('show'); });
    $('#custom-filter-trigger').click(() => $('#filterPanel').slideToggle(300));
    $(document).click(() => $('.dropdown-content').removeClass('show'));
});
</script>
{% endblock %}