{% extends 'adminbase.html' %}
{% load static %}
{% block title %}Stock Management{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/stock/stock_management.css' %}">
<style>
    /* Inline styles for specific table adjustments */
    .hidden { display: none; }
    .variant-row { background-color: #f9fafb; }
    .variant-name { color: #6b7280; padding-left: 20px !important; }
    .toggle-icon { cursor: pointer; transition: transform 0.2s; }
    .toggle-icon.rotate { transform: rotate(90deg); }
    
    /* Price styling */
    .price-display { display: flex; flex-direction: column; font-size: 0.9em; }
    .price-display .offer { font-weight: 600; color: #111827; }
    .price-display .base { font-size: 0.85em; color: #9ca3af; text-decoration: line-through; }
    
    /* Status Tags */
    .status-tag { padding: 4px 8px; border-radius: 4px; font-size: 0.8rem; font-weight: 500; }
    .status-in-stock { background-color: #d1fae5; color: #065f46; }
    .status-low-stock { background-color: #fef3c7; color: #92400e; }
    .status-out-of-stock { background-color: #fee2e2; color: #b91c1c; }
</style>
{% endblock extra_css %}

{% block content %}
<div class="page-header">
    <div>
        <h1>Stock Management</h1>
        <p>Monitor inventory levels by size</p>
    </div>
</div>

<div class="page-filters">
    <form method="GET" class="filter-form">
        <div class="search-bar">
            <i class="fa-solid fa-magnifying-glass"></i>
            {% comment %} <input type="text" placeholder="Search products..."> {% endcomment %}
            <input type="text" name="search" class="form-control"  value="{{ request.GET.search }}">
        </div>
        <select name="category" id="categories">
            <option value="">All Categories</option>
            {% for cat in categorys %}
                <option value="{{ cat.id }}"
                    {% if cat.id|stringformat:"s" == selected_category %}selected{% endif %}>
                    {{ cat.name }}
                </option>
            {% endfor %}
        </select>
        <button class="btn btn-secondary">Filter</button>
        <button class='btn btn-primary' id='findOutOfStock'>Find out of stock</button>
    </form>
</div>

<div class="table-container">
    <table>
        <thead>
            <tr>
                <th style="width: 2%;"></th> 
                <th>Product Name</th>
                <th>Size</th>
                <th>Price (Offer / Base)</th> <th>Stock</th>
                <th>Status</th>
                <th>Actions</th>
            </tr>
        </thead>
       <tbody>
    {% for product in products %}
    <tr class="product-row expandable" data-target="product-{{ product.id }}">
        <td><i class="fa-solid fa-chevron-right toggle-icon"></i></td>
        <td>
            <div class="product-cell">
                {% if product.image %}
                    <img src="{{ product.image.url }}" alt="{{ product.name }}">
                {% endif %}
                <span style="font-weight: 600;">{{ product.name }}</span>
            </div>
        </td>
        <td>{{ product.variants.count }} Variant{{ product.variants.count|pluralize }}</td>
        
        <td>-</td>
        
        <td><strong>{{ product.total_stock|default:0 }} total</strong></td>
        
        <td>
            {% if product.is_active %}
                <span style="color: green; font-size: 0.8em;">Active</span>
            {% else %}
                <span style="color: red; font-size: 0.8em;">Inactive</span>
            {% endif %}
        </td>
    </tr>

    {% for variant in product.variants.all %}
    <tr class="variant-row hidden" data-parent="product-{{ product.id }}">
        <td></td>
        <td class="variant-name">
            <i class="fa-solid fa-turn-up fa-rotate-90" style="margin-right: 8px; color: #9ca3af;"></i> 
            {{ product.name }} - {{ variant.size }}
        </td>
        <td>
            <span style="background: #e5e7eb; padding: 2px 6px; border-radius: 4px; font-size: 0.85em;">
                {{ variant.size }}
            </span>
        </td>
        
        <td>
            <div class="price-display">
                <span class="offer">₹{{ variant.offer_price }}</span>
                <span class="base">₹{{ variant.base_price }}</span>
            </div>
        </td>

        <td>{{ variant.stock }}</td>
        
        <td>
            {% if variant.stock == 0 %}
                <span class="status-tag status-out-of-stock">Out of Stock</span>
            {% elif variant.stock < 10 %}
                <span class="status-tag status-low-stock">Low Stock</span>
            {% else %}
                <span class="status-tag status-in-stock">In Stock</span>
            {% endif %}
        </td>
        
        <td>
            {% comment %} <button class="btn" style="padding: 4px 8px; border: 1px solid #d1d5db; background: white; border-radius: 4px;">
                <i class="fa-solid fa-pen"></i> Edit
            </button> {% endcomment %}
        </td>
    </tr>
    {% endfor %}
    
    {% empty %}
    <tr>
        <td colspan="7" style="text-align: center; padding: 40px; color: #6b7280;">
            No products found in inventory.
        </td>
    </tr>
    {% endfor %}
</tbody>
    </table>
</div>
<section class='pagination-container'>
        <div class="pagination">
            {% if page_obj.has_previous %}
                <a href="?page={{ page_obj.previous_page_number }}{% if query_params %}&{{ query_params }}{% endif %}"><i class="fa-solid fa-chevron-left"></i></a>
            {% else %}
                <span class="disabled"><i class="fa-solid fa-chevron-left"></i></span>
            {% endif %}

            {% for i in custom_page_range %}
                {% if i == paginator.ELLIPSIS %}
                    <span class="ellipsis">...</span>
                {% elif page_obj.number == i %}
                    <span class="current">{{ i }}</span>
                {% else %}
                    <a href="?page={{ i }}{% if query_params %}&{{ query_params }}{% endif %}">{{ i }}</a>
                {% endif %}
            {% endfor %}

            {% if page_obj.has_next %}
                <a href="?page={{ page_obj.next_page_number }}{% if query_params %}&{{ query_params }}{% endif %}"><i class="fa-solid fa-chevron-right"></i></a>
            {% else %}
                <span class="disabled"><i class="fa-solid fa-chevron-right"></i></span>
            {% endif %}
        </div>
    </section>
{% endblock content %}

{% block extraJs %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const expandables = document.querySelectorAll('.expandable');

        expandables.forEach(row => {
            row.addEventListener('click', function(e) {
                // Prevent triggering if clicking buttons/links inside the row
                if (e.target.closest('a') || e.target.closest('button')) return;

                const targetId = this.dataset.target;
                const childRows = document.querySelectorAll(`tr[data-parent="${targetId}"]`);
                const icon = this.querySelector('.toggle-icon');

                // Toggle icon rotation
                icon.classList.toggle('rotate');

                // Toggle visibility of child rows
                childRows.forEach(child => {
                    child.classList.toggle('hidden');
                });
            });
        });
    });
</script>
{% endblock extraJs %}