{% extends 'adminbase.html' %}
{% load static %}

{% block extra_css %}
    <link rel="stylesheet" href="{% static 'css/dashboard/dashboard.css' %}">
{% endblock extra_css %}


{% block content %}
    
    <div class="page-header">
        <div class="header-content">
            <h1>Dashboard</h1>
            <p>Overview of your store's performance</p>
        </div>
    </div>

    <div class="stats-grid">
        
        <div class="stat-card">
            <div class="stat-card-header">
                <span>Total Users</span>
                <div class="stat-icon-wrapper">
                    <a href="{% url 'admin_user' %}">
                        <i class="fa-solid fa-users"></i>
                    </a>
                </div>
            </div>
            <h2 class="stat-card-value">{{ total_users }}</h2>
            <p class="stat-card-footer">+12% from last month</p>
        </div>
        
        <div class="stat-card">
            <div class="stat-card-header">
                <span>Total Products</span>
                <div class="stat-icon-wrapper">
                    <a href="{% url "admin_products" %}">
                        <i class="fa-solid fa-box"></i>
                    </a>
                </div>
            </div>
            <h2 class="stat-card-value">{{ total_products }}</h2>
            <p class="stat-card-footer">+5% from last month</p>
        </div>
        
        <div class="stat-card">
            <div class="stat-card-header">
                <span>Total Orders</span>
                <div class="stat-icon-wrapper">
                    <a href="{% url "Admin_order" %}">
                        <i class="fa-solid fa-cart-shopping"></i>
                    </a>
                </div>
            </div>
            <h2 class="stat-card-value">{{ total_orders }}</h2>
            <p class="stat-card-footer">+15% from last month</p>
        </div>

        <div class="stat-card">
            <div class="stat-card-header">
                <span>Total Revenue</span>
                <div class="stat-icon-wrapper">
                    <i class="fa-solid fa-dollar-sign"></i>
                </div>
            </div>
            <h2 class="stat-card-value">â‚¹{{ total_revenue.total_revenue }}</h2>
            <p class="stat-card-footer">+18% from last month</p>
        </div>
    </div>


    <div class="dashboard-row">
        <div class="card">
            <div class="card-header">
                <h3>Sales Overview</h3>
                <div class="chart-controls">
                    <select id="timeFilter">
                        <option value="all">All Time</option>
                        <option value="today">Today</option>
                        <option value="last7">7Days</option>
                        <option value="last30">30Days</option>
                    </select>
                </div>
            </div>
            <div class="chart-wrapper">
                <canvas id="salesChart"></canvas>
            </div>
        </div>
        
        <div class="card">
            <div class="card-header"><h3>Stats</h3></div>
            <div class="chart-wrapper">
                <canvas id='OrderChart'></canvas>
            </div>
        </div>
    </div>

    <div class="card orders-table">
        <div class="card-header">
            <h3>Recent Orders</h3>
        </div>
        <table class="data-table">
            <thead>
                <tr>
                    <th>Order ID</th>
                    <th>Customer</th>
                    <th>Date</th>
                    <th>Status</th>
                    <th>Total</th>
                    <th>View</th>
                </tr>
            </thead>
            <tbody>
                {% for recent_order in recent_orders %}
                <tr>
                    <td>{{ recent_order.order_id }}</td>
                    <td>{{ recent_order.user }}</td>
                    <td>{{ recent_order.created_at }}</td>
                    <td>    
                        <span class="status-badge status-{{ recent_order.order_status }}">
                            {{ recent_order.get_order_status_display }}
                        </span>
                    </td>
                    <td>â‚¹{{ recent_order.final_price }}</td>
                    <td data-label="Action">
                        <a href="{% url 'Admin_order_detailed_view' recent_order.order_id %}" title="View Details" style="color: #4b5563; text-decoration: underline;">
                            View Details
                        </a></td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
{% endblock content %}
{% block extraJs %}
{# ---- CHART.JS (inline so we know it runs) ---- #}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
const labels = {{ sales_labels|safe }};
const data = {{ sales_data|safe }};
const canvas = document.getElementById('salesChart');


if (canvas) {
    const ctx = canvas.getContext('2d');

    // Gradient fill
    const gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
    gradient.addColorStop(0, 'rgba(0, 0, 0, 1)');
    gradient.addColorStop(1, 'rgba(134, 134, 134, 0.05)');

    const config = {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                data: data,
                borderColor: '#000000ff',
                borderWidth: 2.5,
                backgroundColor: gradient,
                fill: true,
                tension: 0.45,
                pointRadius: 0,
                pointHoverRadius: 6,
                pointBackgroundColor: '#000000ff',
                pointBorderColor: '#ffffff',
                pointBorderWidth: 2,

                // ðŸ”¥ line drawing effect
                borderDash: [2000, 2000],
                borderDashOffset: 2000
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                intersect: false,
                mode: 'index'
            },
            animation: {
                borderDashOffset: {
                    type: 'number',
                    duration: 3500,
                    easing: 'easeInOutSine',
                    from: 2000,
                    to: 0
                }
            },
            plugins: {
                legend: { display: false },
                tooltip: {
                    backgroundColor: '#111827',
                    padding: 12,
                    displayColors: false,
                    callbacks: {
                        title: items => items[0].label,
                        label: item => `â‚¹ ${item.parsed.y.toLocaleString()}`
                    }
                }
            },
            scales: {
                x: {
                    grid: { display: false },
                    ticks: { color: '#6b7280' }
                },
                y: {
                    beginAtZero: true,
                    grid: { color: 'rgba(0,0,0,0.05)' },
                    ticks: {
                        color: '#6b7280',
                        callback: value => `â‚¹${value}`
                    }
                }
            }
        }
    };

    new Chart(ctx, config);
}

const ctx = document.getElementById('OrderChart').getContext('2d');

// Define a color palette mapped to your 7 statuses
const statusColors = {
    'pending': '#ffc107',          // Amber/Yellow
    'confirmed': '#2196f3',        // Blue
    'shipped': '#9c27b0',          // Purple
    'out_for_delivery': '#00bcd4', // Cyan
    'delivered': '#4caf50',        // Green
    'cancelled': '#f44336',        // Red
    'returned': '#607d8b'          // Blue Grey
};

// Map the labels coming from Django to their colors
const chartLabels = {{ order_labels|safe }};
const backgroundColors = chartLabels.map(label => statusColors[label] || '#cccccc');

new Chart(ctx, {
    type: 'doughnut',
    data: {
        labels: chartLabels,
        datasets: [{
            data: {{ order_data|safe }},
            backgroundColor: backgroundColors,
            borderColor: '#ffffff',
            borderWidth: 2,
            cutout: '70%' // Makes the hole larger for the center text
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                position: 'bottom',
                labels: { usePointStyle: true, padding: 20 }
            }
        }
    },
    // Custom plugin to draw the total in the center
    plugins: [{
        id: 'centerText',
        afterDraw: (chart) => {
            const { ctx, chartArea: { top, bottom, left, right, width, height } } = chart;
            ctx.save();
            
            // Calculate total
            const total = chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
            
            ctx.font = 'bold 2rem sans-serif';
            ctx.textAlign = 'center';
            ctx.fillStyle = '#333';
            ctx.fillText(total, width / 2, height / 2 + top + 10);
            
            ctx.font = '1rem sans-serif';
            ctx.fillStyle = '#666';
            ctx.fillText('Total Orders', width / 2, height / 2 + top - 25);
            ctx.restore();
        }
    }]
});
</script>
{% endblock extraJs %}