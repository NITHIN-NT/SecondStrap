{% extends 'adminbase.html' %}
{% load static %}

{% block extra_css %}
    <link rel="stylesheet" href="{% static 'css/dashboard/dashboard.css' %}">
{% endblock extra_css %}


{% block content %}
    
    <div class="page-header">
        <div class="header-content">
            <h1>Dashboard</h1>
            <p>Overview of your store's performance</p>
        </div>
    </div>

    <div class="stats-grid">
        
        <div class="stat-card">
            <div class="stat-card-header">
                <span>Total Users</span>
                <div class="stat-icon-wrapper">
                    <a href="{% url 'admin_user' %}">
                        <i class="fa-solid fa-users"></i>
                    </a>
                </div>
            </div>
            <h2 class="stat-card-value">{{ total_users }}</h2>
            <p class="stat-card-footer">+12% from last month</p>
        </div>
        
        <div class="stat-card">
            <div class="stat-card-header">
                <span>Total Products</span>
                <div class="stat-icon-wrapper">
                    <a href="{% url "admin_products" %}">
                        <i class="fa-solid fa-box"></i>
                    </a>
                </div>
            </div>
            <h2 class="stat-card-value">{{ total_products }}</h2>
            <p class="stat-card-footer">+5% from last month</p>
        </div>
        
        <div class="stat-card">
            <div class="stat-card-header">
                <span>Total Orders</span>
                <div class="stat-icon-wrapper">
                    <a href="{% url "Admin_order" %}">
                        <i class="fa-solid fa-cart-shopping"></i>
                    </a>
                </div>
            </div>
            <h2 class="stat-card-value">{{ total_orders }}</h2>
            <p class="stat-card-footer">+15% from last month</p>
        </div>

        <div class="stat-card">
            <div class="stat-card-header">
                <span>Total Revenue</span>
                <div class="stat-icon-wrapper">
                    <i class="fa-solid fa-dollar-sign"></i>
                </div>
            </div>
            <h2 class="stat-card-value">₹{{ total_revenue.total_revenue|default_if_none:"0" }}</h2>
            {% comment %} <p class="stat-card-footer">+18% from last month</p> {% endcomment %}
            <p class="stat-card-footer">{{revenue.total_revenue}}</p>
        </div>
    </div>


    <div class="dashboard-row">
        <div class="card">
            <div class="card-header">
                <h3>Sales Overview</h3>
                <div class="chart-controls">
                    <select id="timeFilter">
                        <option value="today" selected>Today</option>
                        <option value="last7">7 Days</option>
                        <option value="last30">30 Days</option>
                        <option value="all">All Time</option>
                    </select>
                </div>
            </div>
            <div class="chart-wrapper">
                <canvas id="salesChart"></canvas>
            </div>
        </div>
        
        <div class="card">
            <div class="card-header"><h3>Stats</h3></div>
            <div class="chart-wrapper">
                <canvas id='OrderChart'></canvas>
            </div>
        </div>
    </div>

    <div class="dashboard-row">
        <div class="card">
            <div class="card-header">
                <h3>Top Selling Products</h3>
                <span class="badge-info">All Time</span>
            </div>
            <div class="best-selling-list">
                {% for product in top_products %}
                    <div class="list-item">
                        <div class="item-info">
                            <span class="item-name">{{ product.variant__product__name }}</span>
                            <span class="item-category">{{ product.variant__product__category__name }}</span>
                        </div>
                        <div class="item-stats">
                            <span class="item-count">{{ product.total_sold }} Sold</span>
                        </div>
                    </div>
                {% empty %}
                    <p class="text-muted">No data available</p>
                {% endfor %}
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <h3>Top Categories</h3>
            </div>
            <div class="best-selling-list">
                {% for category in top_categories %}
                <div class="list-item">
                    <div class="item-info">
                        <span class="item-name">{{ category.variant__product__category__name }}</span>
                    </div>
                    <div class="item-progress-wrapper">
                        <div class="progress-bar-container">
                            <div class="progress-bar" style="width: {{ category.percentage }}%;"></div>
                        </div>
                        <span class="item-count">₹{{ category.total_revenue|floatformat:0 }}</span>
                    </div>
                </div>
                {% empty %}
                <p class="text-muted">No data available</p>
                {% endfor %}
            </div>
        </div>
    </div>

    <div class="card orders-table">
        <div class="card-header">
            <h3>Recent Orders</h3>
        </div>
        <table class="data-table">
            <thead>
                <tr>
                    <th>Order ID</th>
                    <th>Customer</th>
                    <th>Date</th>
                    <th>Status</th>
                    <th>Total</th>
                    <th>View</th>
                </tr>
            </thead>
            <tbody>
                {% for recent_order in recent_orders %}
                <tr>
                    <td>{{ recent_order.order_id }}</td>
                    <td>{{ recent_order.user }}</td>
                    <td>{{ recent_order.created_at }}</td>
                    <td>    
                        <span class="status-badge status-{{ recent_order.order_status }}">
                            {{ recent_order.get_order_status_display }}
                        </span>
                    </td>
                    <td>₹{{ recent_order.final_price }}</td>
                    <td data-label="Action">
                        <a href="{% url 'Admin_order_detailed_view' recent_order.order_id %}" title="View Details" style="color: #4b5563; text-decoration: underline;">
                            View Details
                        </a></td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
{% endblock content %}
{% block extraJs %}
{# ---- CHART.JS (inline so we know it runs) ---- #}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script>

    // Add event listener to the select element
document.getElementById('timeFilter').addEventListener('change', async function(e) {
    const filterValue = e.target.value;
    
    try {
        // Show loading state (optional)
        const canvas = document.getElementById('salesChart');
        canvas.style.opacity = '0.5';
        
        // Make API request with the selected filter
        const response = await axios.get('{% url "admin_home" %}', {
            params: {
                filter: filterValue
            }
        });
        
        // Extract the new data from response
        const { labels, data } = response.data;
        
        // Get the existing chart instance
        const chart = Chart.getChart('salesChart');
        
        if (chart) {
            // Update chart data
            chart.data.labels = labels;
            chart.data.datasets[0].data = data;
            
            // Reset animation
            chart.data.datasets[0].borderDashOffset = 2000;
            
            // Update the chart with animation
            chart.update();
        }
        
        // Remove loading state
        canvas.style.opacity = '1';
        
    } catch (error) {
        console.error('Error fetching sales data:', error);
        alert('Failed to load sales data. Please try again.');
    }
});
const labels = {{ sales_labels|safe }};
const data = {{ sales_data|safe }};
const canvas = document.getElementById('salesChart');

if (canvas) {
    const ctx = canvas.getContext('2d');

    // Professional gradient - Indigo to Purple
    const gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
    gradient.addColorStop(0, 'rgba(99, 102, 241, 0.75)');   // Indigo-500
    gradient.addColorStop(1, 'rgba(139, 92, 246, 0.05)');   // Violet-500 fade

    const config = {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                data: data,
                borderColor: '#6366f1',           // Indigo-500
                borderWidth: 3,
                backgroundColor: gradient,
                fill: true,
                tension: 0.4,
                pointRadius: 0,
                pointHoverRadius: 7,
                pointBackgroundColor: '#6366f1',
                pointBorderColor: '#ffffff',
                pointBorderWidth: 3,
                pointHoverBorderWidth: 3,

                // Line drawing effect
                borderDash: [2000, 2000],
                borderDashOffset: 2000
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                intersect: false,
                mode: 'index'
            },
            animation: {
                borderDashOffset: {
                    type: 'number',
                    duration: 3500,
                    easing: 'easeInOutSine',
                    from: 2000,
                    to: 0
                }
            },
            plugins: {
                legend: { display: false },
                tooltip: {
                    backgroundColor: '#1e293b',     // Slate-800
                    titleColor: '#f1f5f9',          // Slate-100
                    bodyColor: '#e2e8f0',           // Slate-200
                    borderColor: '#475569',          // Slate-600
                    borderWidth: 1,
                    padding: 16,
                    displayColors: false,
                    cornerRadius: 8,
                    titleFont: {
                        size: 13,
                        weight: '600'
                    },
                    bodyFont: {
                        size: 14,
                        weight: '700'
                    },
                    callbacks: {
                        title: items => items[0].label,
                        label: item => `₹ ${item.parsed.y.toLocaleString('en-IN')}`
                    }
                }
            },
            scales: {
                x: {
                    grid: { 
                        display: false 
                    },
                    ticks: { 
                        color: '#64748b',            // Slate-500
                        font: {
                            size: 12,
                            weight: '500'
                        }
                    },
                    border: {
                        color: '#e2e8f0'             // Slate-200
                    }
                },
                y: {
                    beginAtZero: true,
                    grid: { 
                        color: '#f1f5f9',            // Slate-100
                        drawBorder: false
                    },
                    ticks: {
                        color: '#64748b',            // Slate-500
                        font: {
                            size: 12,
                            weight: '500'
                        },
                        callback: value => `₹${value.toLocaleString('en-IN')}`
                    },
                    border: {
                        display: false
                    }
                }
            }
        }
    };

    new Chart(ctx, config);
}

// Professional Doughnut Chart
const ctx2 = document.getElementById('OrderChart').getContext('2d');

// Modern, professional color palette
const statusColors = {
    'pending': '#f59e0b',          // Amber-500
    'confirmed': '#3b82f6',        // Blue-500
    'shipped': '#8b5cf6',          // Violet-500
    'out_for_delivery': '#06b6d4', // Cyan-500
    'delivered': '#10b981',        // Emerald-500
    'cancelled': '#ef4444',        // Red-500
    'returned': '#6366f1'          // Indigo-500
};

const chartLabels = {{ order_labels|safe }};
const backgroundColors = chartLabels.map(label => statusColors[label] || '#94a3b8');

new Chart(ctx2, {
    type: 'doughnut',
    data: {
        labels: chartLabels.map(label => 
            label.replace(/_/g, ' ')
                 .replace(/\b\w/g, l => l.toUpperCase())
        ),
        datasets: [{
            data: {{ order_data|safe }},
            backgroundColor: backgroundColors,
            borderColor: '#ffffff',
            borderWidth: 3,
            cutout: '75%',
            hoverOffset: 8,
            hoverBorderWidth: 3
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                position: 'bottom',
                labels: { 
                    usePointStyle: true,
                    pointStyle: 'circle',
                    padding: 20,
                    font: {
                        size: 13,
                        weight: '600',
                        family: "'Inter', 'Segoe UI', sans-serif"
                    },
                    color: '#334155'             // Slate-700
                }
            },
            tooltip: {
                backgroundColor: '#1e293b',      // Slate-800
                titleColor: '#f1f5f9',
                bodyColor: '#e2e8f0',
                borderColor: '#475569',
                borderWidth: 1,
                padding: 12,
                cornerRadius: 8,
                displayColors: true,
                boxWidth: 12,
                boxHeight: 12,
                usePointStyle: true
            }
        }
    },
    plugins: [{
        id: 'centerText',
        afterDraw: (chart) => {
            const { ctx, chartArea: { top, bottom, left, right, width, height } } = chart;
            ctx.save();
            
            const total = chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
            
            // Total number
            ctx.font = 'bold 2.5rem "Inter", sans-serif';
            ctx.textAlign = 'center';
            ctx.fillStyle = '#0f172a';           // Slate-900
            ctx.fillText(total, width / 2, height / 2 + top + 5);
            
            // Label
            ctx.font = '600 0.95rem "Inter", sans-serif';
            ctx.fillStyle = '#64748b';           // Slate-500
            ctx.fillText('Total Orders', width / 2, height / 2 + top - 30);
            
            ctx.restore();
        }
    }]
});
</script>
{% endblock extraJs %}