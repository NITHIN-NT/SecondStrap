{% extends "adminbase.html" %}
{% load static %}
{% block title %}Manage Coupons{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link rel="stylesheet" href="{% static "css/coupons/coupons.css" %}">
{% endblock extra_css %}

{% block content %}
<div class="coupon-container">
    <div class="header-section">
        <div class="header-title">
            <div class="title-group">
                <h1>Coupons</h1>
                <p>Manage discounts, promo codes, and special offers for your customers.</p>
            </div>
            <div class="header-actions">
                <a href="{% url 'admin_manage_coupon' %}" class="btn btn-primary">
                    <i class="fas fa-plus"></i>
                    Create Coupon
                </a>
                <a href="{% url 'admin_coupon_history' %}" class="btn btn-secondary">
                    <i class="fas fa-clock-rotate-left"></i>
                    Coupon History
                </a>
            </div>
        </div>
    </div>

    <div class="filter-tabs">
        <button class="filter-tab active" data-filter="all">All Status</button>
        <button class="filter-tab" data-filter="active">Active</button>
        <button class="filter-tab" data-filter="inactive">Inactive</button>
        <button class="filter-tab" data-filter="scheduled">Scheduled</button>
    </div>

    <div class="search-bar">
        <i class="fas fa-search search-icon"></i>
        <input type="text" class="search-input" placeholder="Search coupons by name or code...">
    </div>

    <div class="coupon-grid">
        {% for coupon in coupons %}
        <div class="coupon-card" data-status="{% if coupon.is_scheduled %}scheduled{% elif coupon.is_active %}active{% else %}inactive{% endif %}">
            <div class="coupon-header">
                <div class="coupon-title">
                    <div class="coupon-name">{{coupon.name}}</div>
                    <div class="coupon-code">
                        <i class="fas fa-tag"></i>
                        {{coupon.code}}
                    </div>
                </div>
                {% if coupon.is_scheduled %}
                <span class="status-badge status-scheduled">Scheduled</span>
                {% elif coupon.is_active %}
                <span class="status-badge status-active">Active</span>
                {% else %}
                <span class="status-badge status-inactive">Inactive</span>
                {% endif %}
            </div>

            <div class="discount-section">
                {% if coupon.coupon_type == 'percentage' %}
                <div class="discount-value">{{coupon.coupon_percentage}}% OFF</div>
                {% else %}
                <div class="discount-value">₹{{coupon.coupon_amount}} OFF</div>
                {% endif %}
                {% if coupon.min_purchase_amount %}
                <div class="discount-min">
                    <i class="fas fa-receipt"></i>
                    Min Purchase: ₹{{coupon.min_purchase_amount}}
                </div>
                {% endif %}
            </div>

            <div class="coupon-details">
                <div class="detail-row">
                    <i class="fas fa-chart-line"></i>
                    <span class="detail-label">Usage:</span>
                    <span class="detail-value">{{coupon.times_used}} / {{coupon.usage_limit}}</span>
                </div>
                <div class="usage-bar">
                    <div class="usage-progress">
                        <div class="usage-fill" style="width: {% widthratio coupon.times_used coupon.usage_limit 100 %}%;"></div>
                    </div>
                </div>
                <div class="detail-row">
                    <i class="fas fa-calendar-alt"></i>
                    <span class="detail-label">Validity:</span>
                    <span class="detail-value">{{coupon.start_date}} <br> to  {{coupon.end_date}}</span>
                </div>
                <div class="detail-row">
                    <i class="fas fa-user-check"></i>
                    {% if coupon.one_time_per_user %}
                    <span class="per-user-badge active">
                        <i class="fas fa-check"></i>
                        One per user
                    </span>
                    {% else %}
                    <span class="per-user-badge">
                        <i class="fas fa-times"></i>
                        Multiple uses allowed
                    </span>
                    {% endif %}
                </div>
            </div>

            <div class="action-buttons">
                <button class="btn-action edit" onclick="window.location.href='{% url 'admin_manage_coupon' coupon.id %}'">
                    <i class="fas fa-pen"></i>
                    Edit
                </button>
                <button class="btn-action delete" onclick="openDeleteModal('{{coupon.id}}')">
                    <i class="fas fa-trash"></i>
                    Delete
                </button>
            </div>
        </div>
        {% empty %}
        <div class="empty-state" style="grid-column: 1 / -1;">
            <div class="empty-icon">
                <i class="fas fa-ticket"></i>
            </div>
            <h3>No coupon available</h3>
            <p>Create your first coupon to start offering discounts to your customers</p>
        </div>
        {% endfor %}
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal" id="deleteModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Confirm Delete</h3>
            <p>Are you sure you want to delete this coupon? This action cannot be undone.</p>
        </div>
        <div class="modal-actions">
            <button class="btn-cancel" onclick="closeModal()">Cancel</button>
            <form id="deleteForm" method="POST" style="flex: 1; margin: 0;">
                {% csrf_token %}
                <button type="submit" class="btn-delete" style="width: 100%;">Delete</button>
            </form>
        </div>
    </div>
</div>
{% endblock content %}

{% block extraJs %}
<script>
    let currentCouponId = null;

    function openDeleteModal(couponId) {
        currentCouponId = couponId;
        document.getElementById('deleteForm').action = `delete/${couponId}/`;
        document.getElementById('deleteModal').classList.add('active');
    }

    function closeModal() {
        document.getElementById('deleteModal').classList.remove('active');
        currentCouponId = null;
    }

    // Close modal when clicking outside
    document.getElementById('deleteModal').addEventListener('click', function(e) {
        if (e.target === this) {
            closeModal();
        }
    });

    // Filter tab functionality
    document.querySelectorAll('.filter-tab').forEach(tab => {
        tab.addEventListener('click', function() {
            // Update active tab
            document.querySelectorAll('.filter-tab').forEach(t => t.classList.remove('active'));
            this.classList.add('active');
            
            // Get filter type
            const filterType = this.getAttribute('data-filter');
            const cards = document.querySelectorAll('.coupon-card');
            
            // Filter cards
            cards.forEach(card => {
                if (filterType === 'all') {
                    card.style.display = 'block';
                } else {
                    const cardStatus = card.getAttribute('data-status');
                    if (cardStatus === filterType) {
                        card.style.display = 'block';
                    } else {
                        card.style.display = 'none';
                    }
                }
            });
            
            // Check if any cards are visible
            const visibleCards = Array.from(cards).filter(card => card.style.display !== 'none');
            const emptyState = document.querySelector('.empty-state');
            
            if (visibleCards.length === 0 && emptyState) {
                emptyState.style.display = 'block';
            } else if (emptyState) {
                emptyState.style.display = 'none';
            }
        });
    });

    // Search functionality
    document.querySelector('.search-input').addEventListener('input', function(e) {
        const searchTerm = e.target.value.toLowerCase();
        const cards = document.querySelectorAll('.coupon-card');
        
        cards.forEach(card => {
            const name = card.querySelector('.coupon-name').textContent.toLowerCase();
            const code = card.querySelector('.coupon-code').textContent.toLowerCase();
            
            if (name.includes(searchTerm) || code.includes(searchTerm)) {
                card.style.display = 'block';
            } else {
                card.style.display = 'none';
            }
        });
    });
</script>
{% endblock extraJs %}