{% extends 'adminbase.html' %}
{% load static %}
{% block title %}Manage Categories{% endblock %}
{% block extra_css %}
    <link rel="stylesheet" href="{% static 'css/category/category.css' %}">
{% endblock extra_css %}

{% block content %}
    
    <div class="page-header-container">
        <div class="page-header">
            <h1>Category Management</h1>
            <p>View and manage your product categories.</p>
        </div>
        <a href="{% url 'admin_category_add' %}" class="btn btn-primary">
            <i class="fa-solid fa-plus"></i>
            Add New Category
        </a>
    </div>

    <div class="data-table-card">
        <form method="get">
            <div class="table-toolbar">
                <div class="search-bar">
                    <i class="fa-solid fa-search"></i>
                    <input type="text" name="search" placeholder="Search categories by name..." value="{{ search|default:'' }}">
                </div>
                <div class="filters">
                    <select name="category_status" class='filter-dropdown' onchange="this.form.submit()">
                        <option value="" {% if status == "" %}selected{% endif %}>All Status</option>
                        <option value="active" {% if status == "active" %}selected{% endif %}>Active</option>
                        <option value="blocked" {% if status == "blocked" %}selected{% endif %}>Blocked</option>
                    </select>
                    <a href="{% url 'admin_category' %}" class="btn btn-secondary" title="Reset Filters">
                        <i class="fa-solid fa-rotate-right"></i>
                    </a>
                </div>
            </div>
        </form>

        <div class="table-responsive">
            <table class="custom-table">
                <thead>
                    <tr>
                        <th width="25%">Category Name</th>
                        <th width="35%">Description</th>
                        <th width="10%" style="text-align: center;">Products</th>
                        <th width="15%">Status</th>
                        <th width="15%" class="text-end">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for category in categorys %}
                    <tr>
                        <td>
                            <div class="cat-name-wrapper">
                                <div style="display: flex; flex-direction: column;">
                                    <strong>{{ category.name }}</strong>
                                    <small style="color: #94a3b8;">ID: #{{ category.id }}</small>
                                </div>
                            </div>
                        </td>
                        <td>
                            <p class="desc-text">{{ category.description|default:"No description available"|truncatechars:80 }}</p>
                        </td>
                        <td style="text-align: center;">
                            <span class="count-badge">{{ category.count|default:0 }}</span>
                        </td>
                        <td>
                            {% if category.is_active %}
                                <span class="status-badge status-active">
                                    <i class="fa-solid fa-circle-check" style="margin-right: 4px;"></i>Active
                                </span>
                            {% else %}
                                <span class="status-badge status-blocked">
                                    <i class="fa-solid fa-circle-xmark" style="margin-right: 4px;"></i>Blocked
                                </span>
                            {% endif %}
                        </td>
                        <td class="text-end">
                            <div class="action-buttons">
                                <a href="{% url 'admin_category_edit' category.id %}" class="btn-icon btn-edit" title="Edit Category">
                                    <i class="fa-solid fa-pen"></i> Edit
                                </a>

                                {% if category.is_active %}
                                    <form action="{% url 'admin_category_block' category.id %}" method="POST" id="block-form-{{ category.id }}">
                                        {% csrf_token %}
                                        <button type="button" 
                                                class="btn-icon btn-block-action modal-trigger" 
                                                title="Block Category"
                                                data-action="block"
                                                data-form-id="block-form-{{ category.id }}">
                                            <i class="fas fa-ban"></i> Block
                                        </button>
                                    </form>
                                {% else %}
                                    <form action="{% url 'admin_category_block' category.id %}" method="POST" id="unblock-form-{{ category.id }}">
                                        {% csrf_token %}
                                        <button type="button" 
                                                class="btn-icon btn-unblock-action modal-trigger" 
                                                title="Unblock Category"
                                                data-action="unblock"
                                                data-form-id="unblock-form-{{ category.id }}">
                                            <i class="fas fa-unlock"></i> Unblock
                                        </button>
                                    </form>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="5" style="text-align: center; padding: 40px; color: #64748b;">
                            <i class="fa-regular fa-folder-open" style="font-size: 48px; margin-bottom: 16px; opacity: 0.5;"></i>
                            <p>No categories found matching your search.</p>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <section class='pagination-container'>
        <div class="pagination">
            {% if page_obj.has_previous %}
                <a href="?page={{ page_obj.previous_page_number }}{% if query_params %}&{{ query_params }}{% endif %}"><i class="fa-solid fa-chevron-left"></i></a>
            {% else %}
                <span class="disabled"><i class="fa-solid fa-chevron-left"></i></span>
            {% endif %}

            {% for i in custom_page_range %}
                {% if i == paginator.ELLIPSIS %}
                    <span class="ellipsis">...</span>
                {% elif page_obj.number == i %}
                    <span class="current">{{ i }}</span>
                {% else %}
                    <a href="?page={{ i }}{% if query_params %}&{{ query_params }}{% endif %}">{{ i }}</a>
                {% endif %}
            {% endfor %}

            {% if page_obj.has_next %}
                <a href="?page={{ page_obj.next_page_number }}{% if query_params %}&{{ query_params }}{% endif %}"><i class="fa-solid fa-chevron-right"></i></a>
            {% else %}
                <span class="disabled"><i class="fa-solid fa-chevron-right"></i></span>
            {% endif %}
        </div>
    </section>

    <div class="modal-overlay" id="confirmation-modal-overlay">
        <div class="modal-content">
            <h2 id="modal-title">Confirm Action</h2>
            <p id="modal-text">Are you sure you want to proceed?</p>
            <div class="modal-actions">
                <button type="button" class="btn btn-secondary" id="modal-btn-cancel">Cancel</button>
                <button type="button" class="btn btn-danger" id="modal-btn-confirm">Confirm</button>
            </div>
        </div>
    </div>

{% endblock content %}

{% block extraJs %}
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // === MODAL LOGIC ===
            const modalOverlay = document.getElementById('confirmation-modal-overlay');
            const cancelBtn = document.getElementById('modal-btn-cancel');
            const confirmBtn = document.getElementById('modal-btn-confirm');
            const modalTitle = document.getElementById('modal-title');
            const modalText = document.getElementById('modal-text');
            
            let targetFormId = null;

            // Open Modal
            document.querySelectorAll('.modal-trigger').forEach(button => {
                button.addEventListener('click', function () {
                    targetFormId = this.getAttribute('data-form-id');
                    const actionType = this.getAttribute('data-action');

                    // Customize message based on action
                    if (actionType === 'block') {
                        modalTitle.textContent = 'Block Category?';
                        modalText.textContent = 'This category will be hidden from users. Products in this category may also be affected.';
                        confirmBtn.className = 'btn btn-danger'; // Red for danger
                        confirmBtn.textContent = 'Block';
                    } else {
                        modalTitle.textContent = 'Unblock Category?';
                        modalText.textContent = 'This category will be visible to users again.';
                        confirmBtn.className = 'btn btn-primary'; // Purple for safe
                        confirmBtn.textContent = 'Unblock';
                    }

                    modalOverlay.classList.add('show');
                });
            });

            // Close Modal
            function closeModal() {
                modalOverlay.classList.remove('show');
                targetFormId = null;
            }

            cancelBtn.addEventListener('click', closeModal);
            
            // Close on click outside
            modalOverlay.addEventListener('click', (e) => {
                if (e.target === modalOverlay) closeModal();
            });

            // Confirm Action
            confirmBtn.addEventListener('click', function () {
                if (targetFormId) {
                    document.getElementById(targetFormId).submit();
                }
            });
        });
    </script>
{% endblock extraJs %}