{% extends 'base.html' %}
{% load static %}
{% load cloudinary %}

{% block title %}Home{% endblock %}

{% block extra_styles %}
<link rel="stylesheet" href="{% static 'css/products/home.css' %}">
{% endblock extra_styles %}

{% block content %}

{% if images %}
    {% for image in images %}
        <section class="hero-section" style="background-image: url('{{ image.image.url }}');">
    {% endfor %}
{% else %}
    <section class="hero-section" style="background-image: url('{% static 'images/fashion.jpg' %}');">
{% endif %}
        <div class="hero-content">
            <h1>Effortless Style, Arrived.</h1>
            <p>Discover our new Spring collection.</p>
        </div>
    </section>

<section class="home-section">
    <h2 class="section-title">Shop By Category</h2>
    <div class="category-grid">
        {% for category_data in categories_for_template %}
        <a href="{% url 'products_page_user' %}?category={{ category_data.id }}" class="category-card">
            <span>{{ category_data.name }}</span>
            <img src="{{ category_data.image.url}}" alt="{{ category_data.alt_text }}">
        </a>
        {% endfor %}
    </div>
</section>

{% if featured_products %}
<section class="home-section">
    <h2 class="section-title">Featured Products</h2>
    <div class="product-grid">
        {% for featured_product in featured_products %}
            <div class="product-card">
                <div class="product-image-container">
                    {% if featured_product.slug %}
                    <a href="{% url 'products_page_user' %}?category={{ featured_product.category.id}}">
                        {% if featured_product.image %}
                        <img src="{{ featured_product.image.url }}" alt="{{ featured_product.name }}">
                        {% else %}
                        <div class="image-placeholder"></div>
                        {% endif %}
                    </a>
                    {% endif %}
                </div>
                <div class="product-info">
                    <h3 class="product-name"><a href="{% url 'Product_card_view' featured_product.slug %}">{{ featured_product.name }}</a></h3>
                    <p class="product-price">{{ featured_product.offer_price }}</p>
                </div>
            </div>
        {% endfor %}
    </div>
</section>
{% endif %}

 {% if most_demanded %}
<section class="home-section">
    <h2 class="section-title">Most Demanded Accessories</h2>
    <div class="product-grid">
        {% for most_demand in most_demanded %}
        <div class="product-card">
            <div class="product-image-container">
                <a href="{% url 'Product_card_view' most_demand.variant__product__slug %}">
                    {% if most_demand.image %}
                    <img src="{% cloudinary_url most_demand.image %}" alt="{{ most_demand.name }}">
                    {% else %}
                    <div class="image-placeholder"></div>
                    {% endif %}
                </a>
                <div class="product-card-icons">
                    <button 
                        type="button" 
                        class="wishlist-btn" 
                        data-variant-id="{{ most_demand.variant_id }}" 
                        aria-label="Add to wishlist">
                        <i class='bx bx-heart'></i>
                    </button>
                    <a href="{% url 'products_page_user' %}?category={{ most_demand.category_id}}">
                        <button aria-label="Quick view"><i class='bx bx-search'></i></button>
                    </a>
                </div>
            </div>
            <div class="product-info">
                <h3 class="product-name"><a href="{% url 'Product_card_view' most_demand.variant__product__slug %}">{{ most_demand.name }}</a></h3>
                <p class="product-price">{{ most_demand.offer_price }}</p>
            </div>
        </div>
        {% endfor %}
    </div>
</section>
{% endif %} 
{% endblock content %}
{% block extra_script %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // 1. CSRF Helper (Ensures security for POST requests)
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');

    // 2. Event Delegation (Works for all current and future wishlist buttons)
    document.addEventListener('click', function(e) {
        const button = e.target.closest('.wishlist-btn');
        if (!button) return;

        e.preventDefault();
        
        const variantId = button.dataset.variantId;
        const icon = button.querySelector('i');

        if (!variantId || variantId === "None") {
            toastr.warning("Please select a valid product variant.");
            return;
        }

        // UI State: Disable to prevent spamming
        button.disabled = true;

        axios.post("{% url 'add_to_wishlist' %}", {
            variant_id: variantId
        }, {
            headers: {
                'X-CSRFToken': csrftoken,
                'Content-Type': 'application/json'
            }
        })
        .then(response => {
            // Handles 200 (Created)
            toastr.success(response.data.message);
            icon.classList.replace('bx-heart', 'bxs-heart');
            button.style.color = "#ff4757"; 
        })
        .catch(error => {
            // This captures 400, 401, 208, and 500 status codes
            if (error.response) {
                const status = error.response.status;
                const message = error.response.data.message;

                if (status === 401) {
                    toastr.info("Please login to continue.");
                    // Optional: Redirect to login
                    // window.location.href = "{% url 'login' %}?next=" + window.location.pathname;
                } else if (status === 208) {
                    // Item already in cart logic from your view
                    toastr.info(message || "Item is already in your cart.");
                } else if (status === 400) {
                    // Item already in wishlist logic from your view
                    toastr.warning(message || "Item is already in your wishlist.");
                } else {
                    toastr.error(message || "Something went wrong.");
                }
            } else {
                toastr.error("Network error. Please check your connection.");
            }
        })
        .finally(() => {
            button.disabled = false;
        });
    });
});
</script>
{% endblock extra_script %}