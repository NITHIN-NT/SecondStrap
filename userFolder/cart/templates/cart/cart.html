{% extends 'base.html' %}
{% load static %}

{% block title %}Your Cart{% endblock %}

{% block extra_styles %}
<link rel="stylesheet" href="{% static 'css/cart/cart.css' %}">
{% endblock %}

{% block content %}
{% if total_quantity > 0 %}

<div class="cart-container">
    
    <div class="cart-left">
        <h2>Your Cart</h2>
        
        <div class="cart-header">
            <span>Product</span>
            <span>Price</span>
            <span>Quantity</span>
            <span>Subtotal</span>
        </div>
        
        {% for item in cartitems %}
        <div class="cart-row"
             data-item-id="{{ item.id }}"
             data-price="{{ item.final_price }}"
             data-stock="{{ item.variant.stock }}"
             data-discount="{{ item.actual_discount }}">
            
            <div class="cart-product">
                <div class="product-img-wrapper {% if item.variant.stock <= 0 %}faded{% endif %}">
                    <img src="{{ item.variant.product.image.url }}" alt="Product">
                    
                    {% if item.variant.stock <= 0 or item.variant.product.is_active == False %}
                        <div class="oos-overlay">
                            <span class="oos-text">Out of Stock</span>
                        </div>
                    {% endif %}
                </div>
                
                <div class="cart-info">
                    <h3>{{ item.variant.product.name }}</h3>
                    <p class="size">Size: {{ item.size }}</p>

                    {% if item.actual_discount > 0 %}
                        <p class="discount-badge" style="color: #000000ff; font-weight: 600; font-size: 0.9rem;">
                            You Save: ‚Çπ{{ item.actual_discount|floatformat:0 }}
                        </p>
                    {% endif %}
                    
                    <a href="#" class="remove" data-item-id="{{ item.id }}">
                        <span>üóëÔ∏è</span> Remove
                    </a>
                </div>
            </div>
            
            <div class="cart-price">
                <span class="current-price">‚Çπ{{ item.final_price|floatformat:2 }}</span>
                
                {% if item.actual_discount > 0 %}
                    <p><del style="color: #999; font-size: 0.9rem;">‚Çπ{{ item.product_base_price|floatformat:2 }}</del></p>
                {% endif %}
            </div>
            
            <div class="cart-qty" data-item-id="{{ item.id }}" data-stock="{{ item.variant.stock }}">
                {% if item.variant.stock <= 0 or item.variant.product.is_active == False %}
                    <span class="qty-value">{{ item.quantity }}</span>
                {% else %}
                    <button class="qty-btn minus" data-item-id="{{ item.id }}">‚àí</button>
                    <span class="qty-value">{{ item.quantity }}</span>
                    <button class="qty-btn plus" data-item-id="{{ item.id }}">+</button>
                {% endif %}
            </div>
            
            <div class="cart-subtotal">
                ‚Çπ{{ item.product_total|floatformat:2 }}
            </div>
            
        </div>
        {% endfor %}
        
        <div class="cart-summary-left">
            <p>
                <strong>Subtotal:</strong>
                <span id="summary-left-subtotal">‚Çπ{{ total_price|floatformat:2 }}</span>
            </p>
            <small>Shipping and taxes calculated at checkout</small>
            
            <div class="cart-buttons">
                <a href="{% url 'products_page_user' %}" class="btn-light">Continue Shopping</a>
                <a href="{% url 'checkout' %}" class="btn-dark">Proceed to Checkout</a>
            </div>
        </div>
    </div>
    
    <div class="cart-right">
        <h3>Order Summary</h3>
        
        {% for item in cartitems %}
        <div class="summary-item" data-item-id="{{ item.id }}">
            <div>
                <strong>{{ item.variant.product.name }}</strong>
                <p class="summary-qty">Qty: {{ item.quantity }}</p>
                {% if item.actual_discount > 0 %}
                    <p class="summary-savings" style="color: #28a745; font-size: 0.85rem;">
                        Save: ‚Çπ{{ item.actual_discount|floatformat:0 }} each
                    </p>
                {% endif %}
            </div>
            <span class="summary-subtotal">‚Çπ{{ item.product_total|floatformat:2 }}</span>
        </div>
        {% endfor %}
        
        <hr>
        
        <div class="summary-item">
            <span>Subtotal</span>
            <span id="summary-right-subtotal">‚Çπ{{ subtotal|floatformat:2 }}</span>
        </div>
        
        {% if total_savings > 0 %}
        <div class="summary-item" style="color: #28a745;">
            <span>Total Savings</span>
            <span id="summary-right-savings">‚àí‚Çπ{{ total_savings|floatformat:2 }}</span>
        </div>
        {% endif %}
            
        <hr>
            
        <div class="summary-total">
            <strong>Total</strong>
            <strong id="summary-right-total">‚Çπ{{ total_price|floatformat:2 }}</strong>
        </div>
    </div>
        
</div>

{% else %}
<div class="cart-empty-container">
    <h2 class="barlow-condensed-semibold">Your Cart</h2>
    <p>Your cart is currently empty.</p>
    
    {% if user.is_authenticated %}
        <a href="{% url 'products_page_user' %}" class="btn-dark">Continue Shopping</a>
    {% else %}
        <a href="{% url 'login' %}" class="btn-dark">Login to Continue</a>   
    {% endif %}
</div>
{% endif %}

{% endblock %}

{% block extra_script %}
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script>
document.addEventListener("DOMContentLoaded", function () {
    const USER_LIMIT = 10;

    function toastOptions() {
        if (typeof toastr === "undefined") return;

        toastr.options = {
            closeButton: true,
            progressBar: true,
            newestOnTop: true,
            positionClass: "toast-top-right",
            timeOut: "2500",
        };
    }

    function showToast(message, type = "error") {
        toastOptions();

        if (typeof toastr === "undefined") {
            console.log(message);
            return;
        }

        if (type === "success") toastr.success(message);
        else if (type === "info") toastr.info(message);
        else toastr.error(message);
    }

    function getErrorMessage(error) {
        return (
            error?.response?.data?.message ||
            error?.response?.data?.detail ||
            error?.message ||
            "Something went wrong"
        );
    }

    function formatCurrency(amount) {
        const num = Number(amount);
        if (isNaN(num)) return "‚Çπ0.00";
        return "‚Çπ" + num.toFixed(2);
    }

    function recalcTotals() {
        const rows = document.querySelectorAll(".cart-row");
        let total = 0;
        let totalSavings = 0;

        rows.forEach(row => {
            const subtotalEl = row.querySelector(".cart-subtotal");
            if (!subtotalEl) return;

            const subtotalText = subtotalEl.textContent || "";
            const subtotalCleaned = subtotalText.replace(/[^\d.]/g, "");
            const subtotalValue = parseFloat(subtotalCleaned) || 0;
            total += subtotalValue;

            const discount = parseFloat(row.getAttribute("data-discount")) || 0;
            const qtySpan = row.querySelector(".qty-value");
            const qty = parseInt(qtySpan.textContent, 10) || 1;
            totalSavings += discount * qty;
        });

        const leftSubtotal = document.getElementById("summary-left-subtotal");
        const rightSubtotal = document.getElementById("summary-right-subtotal");
        const rightTotal = document.getElementById("summary-right-total");
        const leftSavings = document.getElementById("summary-left-savings");
        const rightSavings = document.getElementById("summary-right-savings");

        const fmtTotal = formatCurrency(total);
        const fmtSavings = formatCurrency(totalSavings);

        if (leftSubtotal) leftSubtotal.textContent = fmtTotal;
        if (rightSubtotal) rightSubtotal.textContent = fmtTotal;
        if (rightTotal) rightTotal.textContent = fmtTotal;

        if (totalSavings > 0) {
            if (leftSavings) {
                leftSavings.textContent = fmtSavings;
                leftSavings.parentElement.style.display = "block";
            }
            if (rightSavings) {
                rightSavings.textContent = "‚àí" + fmtSavings;
                rightSavings.parentElement.style.display = "flex";
            }
        } else {
            if (leftSavings) leftSavings.parentElement.style.display = "none";
            if (rightSavings) rightSavings.parentElement.style.display = "none";
        }
    }


    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== "") {
            const cookies = document.cookie.split(";");
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + "=")) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    const csrftoken = getCookie("csrftoken");
    axios.defaults.headers.common["X-CSRFToken"] = csrftoken;

    function checkStockLimitsOnLoad() {
        const rows = document.querySelectorAll(".cart-row");
        let changesMade = false;

        rows.forEach(row => {
            const itemId = row.getAttribute("data-item-id");
            const stock = parseInt(row.getAttribute("data-stock") || "0", 10);
            const qtySpan = row.querySelector(".qty-value");
            let currentQty = parseInt(qtySpan.textContent, 10) || 0;

            const effectiveLimit = Math.min(stock, USER_LIMIT);

            if (currentQty > effectiveLimit) {
                const newQty = effectiveLimit > 0 ? effectiveLimit : 0;

                qtySpan.textContent = newQty;

                const unitPrice = parseFloat(row.getAttribute("data-price")) || 0;
                const newSubtotal = unitPrice * newQty;

                const rowSubtotalEl = row.querySelector(".cart-subtotal");
                if (rowSubtotalEl) rowSubtotalEl.textContent = formatCurrency(newSubtotal);

                const summaryItem = document.querySelector(`.cart-right .summary-item[data-item-id="${itemId}"]`);
                if (summaryItem) {
                    const qtyTextEl = summaryItem.querySelector(".summary-qty");
                    const sumSubEl = summaryItem.querySelector(".summary-subtotal");

                    if (qtyTextEl) qtyTextEl.textContent = `Qty: ${newQty}`;
                    if (sumSubEl) sumSubEl.textContent = formatCurrency(newSubtotal);
                }

                if (newQty > 0) {
                    axios.post("{% url 'update_cart_item_quantity' %}", {
                        item_id: itemId,
                        quantity: newQty
                    }).catch(err => console.error("Auto-correction sync failed", err));
                }

                changesMade = true;
            }
        });

        if (changesMade) {
            recalcTotals();
            showToast("Cart quantities adjusted based on available stock.", "info");
        }
    }

    checkStockLimitsOnLoad();

    document.querySelectorAll(".remove").forEach(btn => {
        btn.addEventListener("click", function (e) {
            e.preventDefault();
            const itemId = this.getAttribute("data-item-id");

            axios.post("{% url 'remove_cart_item' %}", { item_id: itemId })
            .then(response => {
                const data = response.data;

                if (data.status === "success") {
                    const row = document.querySelector(`.cart-row[data-item-id="${itemId}"]`);
                    if (row && row.parentNode) row.parentNode.remove();

                    const summaryItem = document.querySelector(`.cart-right .summary-item[data-item-id="${itemId}"]`);
                    if (summaryItem && summaryItem.parentNode) summaryItem.parentNode.remove();

                    recalcTotals();

                    showToast("Item removed from cart", "success");

                    const remainingRows = document.querySelectorAll(".cart-row");
                    if (remainingRows.length === 0) location.reload();
                } else {
                    showToast(data.message || "Failed to remove item", "error");
                }
            })
            .catch(error => {
                showToast(getErrorMessage(error), "error");
            });
        });
    });

    document.addEventListener("click", function (e) {
        const plusBtn = e.target.closest(".qty-btn.plus");
        const minusBtn = e.target.closest(".qty-btn.minus");
        if (!plusBtn && !minusBtn) return;

        e.preventDefault();

        const btn = plusBtn || minusBtn;
        const itemId = btn.getAttribute("data-item-id");
        const row = document.querySelector(`.cart-row[data-item-id="${itemId}"]`);
        if (!row) return;

        const qtySpan = row.querySelector(".qty-value");
        let currentQty = parseInt(qtySpan.textContent, 10) || 1;
        const delta = plusBtn ? 1 : -1;
        const newQty = currentQty + delta;

        const stockAttr = row.getAttribute("data-stock") || "0";
        const stock = parseInt(stockAttr, 10);

        if (newQty < 1) return;

        const effectiveLimit = Math.min(stock, USER_LIMIT);

        if (plusBtn && newQty > effectiveLimit) {
            showToast(`Only ${effectiveLimit} item(s) allowed.`, "info");
            return;
        }

        qtySpan.textContent = newQty;

        const unitPrice = parseFloat(row.getAttribute("data-price")) || 0;
        const newSubtotal = unitPrice * newQty;

        const rowSubtotalEl = row.querySelector(".cart-subtotal");
        if (rowSubtotalEl) rowSubtotalEl.textContent = formatCurrency(newSubtotal);

        const summaryItem = document.querySelector(`.cart-right .summary-item[data-item-id="${itemId}"]`);
        if (summaryItem) {
            const qtyTextEl = summaryItem.querySelector(".summary-qty");
            const sumSubEl = summaryItem.querySelector(".summary-subtotal");

            if (qtyTextEl) qtyTextEl.textContent = `Qty: ${newQty}`;
            if (sumSubEl) sumSubEl.textContent = formatCurrency(newSubtotal);
        }

        recalcTotals();

        axios.post("{% url 'update_cart_item_quantity' %}", {
            item_id: itemId,
            quantity: newQty
        })
        .then(response => {
            const data = response.data;

            if (data.status !== "success") {
                showToast(data.message || "Quantity update failed", "error");
                setTimeout(() => location.reload(), 600);
            }
        })
        .catch(error => {
            showToast(getErrorMessage(error), "error");
            setTimeout(() => location.reload(), 600);
        });
    });

});
</script>
{% endblock %}