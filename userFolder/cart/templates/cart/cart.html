{% extends 'base.html' %}
{% load static %}

{% block title %}Your Cart{% endblock %}

{% block extra_styles %}
<link rel="stylesheet" href="{% static 'css/cart/cart.css' %}">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css">
{% endblock %}

{% block content %}
{% if total_quantity > 0 %}

<div class="cart-container">
    
    <!-- LEFT: CART ITEMS -->
    <div class="cart-left">
        <h2>Your Cart</h2>
        
        <div class="cart-header">
            <span>Product</span>
            <span>Price</span>
            <span>Quantity</span>
            <span>Subtotal</span>
        </div>
        
        {% for item in cartitems %}
        <div class="cart-row"
             data-item-id="{{ item.id }}"
             data-price="{{ item.variant.offer_price }}"
             data-stock="{{ item.variant.stock }}">
            
            <!-- PRODUCT -->
            <div class="cart-product">
                <img src="{{ item.variant.product.image.url }}" alt="Product">
                
                <div class="cart-info">
                    <h3>{{ item.variant.product.name }}</h3>
                    <p class="size">Size: {{ item.size }}</p>
                    
                    <a href="#" class="remove" data-item-id="{{ item.id }}">
                        <span>üóëÔ∏è</span> Remove
                    </a>
                </div>
            </div>
            
            <!-- PRICE (unit price) -->
            <div class="cart-price">
                ‚Çπ{{ item.variant.offer_price }}
                {% if item.variant.base_price %}
                <p><del>‚Çπ{{ item.variant.base_price }}</del></p>
                {% endif %}
            </div>
            
            <!-- QUANTITY WITH + / - -->
            <div class="cart-qty" data-item-id="{{ item.id }}" data-stock="{{ item.variant.stock }}">
                <button class="qty-btn minus" data-item-id="{{ item.id }}">‚àí</button>
                <span class="qty-value">{{ item.quantity }}</span>
                <button class="qty-btn plus" data-item-id="{{ item.id }}">+</button>
            </div>
            
            <!-- SUBTOTAL (price √ó quantity) -->
            <div class="cart-subtotal">
                ‚Çπ{{ item.subtotal }}
            </div>
            
        </div>
        {% endfor %}
        
        <!-- SUMMARY BELOW LEFT SECTION -->
        <div class="cart-summary-left">
            <p>
                <strong>Subtotal:</strong>
                <span id="summary-left-subtotal">‚Çπ{{ total_price }}</span>
            </p>
            <small>Shipping and taxes calculated at checkout</small>
            
            <div class="cart-buttons">
                <a href="{% url 'products_page_user' %}" class="btn-light">Continue Shopping</a>
                <a href="#" class="btn-dark">Proceed to Checkout</a>
            </div>
        </div>
    </div>
    
    <!-- RIGHT: ORDER SUMMARY -->
    <div class="cart-right">
        <h3>Order Summary</h3>
        
        {% for item in cartitems %}
        <div class="summary-item" data-item-id="{{ item.id }}">
            <div>
                <strong>{{ item.variant.product.name }}</strong>
                <p class="summary-qty">Qty: {{ item.quantity }}</p>
            </div>
            <span class="summary-subtotal">‚Çπ{{ item.subtotal }}</span>
        </div>
        {% endfor %}
        
        <hr>
        
        <div class="summary-item">
            <span>Subtotal</span>
            <span id="summary-right-subtotal">‚Çπ{{ total_price }}</span>
        </div>
            
        <hr>
            
        <div class="summary-total">
            <strong>Total</strong>
            <strong id="summary-right-total">‚Çπ{{ total_price }}</strong>
        </div>
    </div>
        
</div>

{% else %}
<div class="cart-empty-container">
    <h2 class="barlow-condensed-semibold">Your Cart</h2>
    <p>Your cart is currently empty.</p>
    
    {% if user.is_authenticated %}
        <a href="{% url 'products_page_user' %}" class="btn-dark">Continue Shopping</a>
    {% else %}
        <a href="{% url 'login' %}" class="btn-dark">Login Continue</a>   
    {% endif %}
</div>
{% endif %}

{% endblock %}
{% block extra_script %}
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>

<script>
document.addEventListener("DOMContentLoaded", function () {

    // 1. CONFIGURATION
    const USER_LIMIT = 10; // Max items a user can buy per product

    toastr.options = {
        closeButton: true,
        progressBar: true,
        positionClass: "toast-top-right",
        timeOut: 4000 // Slightly longer so they see the adjustment message
    };

    // 2. HELPER FUNCTIONS
    function formatCurrency(amount) {
        return "‚Çπ" + Number(amount).toLocaleString("en-IN");
    }

    function recalcTotals() {
        const rows = document.querySelectorAll(".cart-row");
        let total = 0;

        rows.forEach(row => {
            const subtotalEl = row.querySelector(".cart-subtotal");
            if (!subtotalEl) return;
            const text = subtotalEl.textContent || "";
            const cleaned = text.replace(/[^\d.]/g, "");
            const value = parseFloat(cleaned) || 0;
            total += value;
        });

        const leftSubtotal  = document.getElementById("summary-left-subtotal");
        const rightSubtotal = document.getElementById("summary-right-subtotal");
        const rightTotal    = document.getElementById("summary-right-total");

        const fmtTotal = formatCurrency(total);

        if (leftSubtotal)  leftSubtotal.textContent  = fmtTotal;
        if (rightSubtotal) rightSubtotal.textContent = fmtTotal;
        if (rightTotal)    rightTotal.textContent    = fmtTotal;
    }

    // 3. CSRF SETUP
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== "") {
            const cookies = document.cookie.split(";");
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + "=")) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    const csrftoken = getCookie("csrftoken");
    axios.defaults.headers.common["X-CSRFToken"] = csrftoken;

    // 4. AUTOMATIC STOCK CHECK ON LOAD
    function checkStockLimitsOnLoad() {
        const rows = document.querySelectorAll(".cart-row");
        let changesMade = false;

        rows.forEach(row => {
            const itemId = row.getAttribute("data-item-id");
            const stock = parseInt(row.getAttribute("data-stock") || "0", 10);
            const qtySpan = row.querySelector(".qty-value");
            let currentQty = parseInt(qtySpan.textContent, 10) || 0;

            // Calculate the effective limit: Is stock lower? Or is User limit (10) lower?
            const effectiveLimit = Math.min(stock, USER_LIMIT);

            // If current quantity exceeds what is allowed
            if (currentQty > effectiveLimit) {
                const oldQty = currentQty;
                const newQty = effectiveLimit; // Set to max available/allowed

                // A. Visual Updates
                qtySpan.textContent = newQty;
                
                // Update Row Subtotal
                const unitPrice = parseFloat(row.getAttribute("data-price")) || 0;
                const newSubtotal = unitPrice * newQty;
                const rowSubtotalEl = row.querySelector(".cart-subtotal");
                if (rowSubtotalEl) rowSubtotalEl.textContent = formatCurrency(newSubtotal);

                // Update Summary Section
                const summaryItem = document.querySelector(`.cart-right .summary-item[data-item-id="${itemId}"]`);
                if (summaryItem) {
                    const qtyTextEl = summaryItem.querySelector(".summary-qty");
                    const sumSubEl  = summaryItem.querySelector(".summary-subtotal");
                    // Regex to replace just the number in "Qty: 5"
                    if (qtyTextEl) qtyTextEl.innerHTML = qtyTextEl.innerHTML.replace(/Qty: \d+/, `Qty: ${newQty}`);
                    if (sumSubEl)  sumSubEl.textContent = formatCurrency(newSubtotal);
                }

                // B. Notify User
                let reason = stock < USER_LIMIT ? "Low Stock" : "Limit Exceeded";
                toastr.warning(`Item quantity reduced from ${oldQty} to ${newQty}. (${reason})`);

                // C. Sync Backend (Quietly)
                axios.post("{% url 'update_cart_item_quantity' %}", {
                    item_id: itemId,
                    quantity: newQty
                }).catch(err => console.error("Auto-correction sync failed", err));

                changesMade = true;
            }
        });

        // D. Final Total Recalculation if we changed anything
        if (changesMade) {
            recalcTotals();
        }
    }

    // Run the check immediately
    checkStockLimitsOnLoad();


    // 5. EVENT LISTENERS (Remove & Quantity Buttons)

    // REMOVE ITEM
    document.querySelectorAll(".remove").forEach(btn => {
        btn.addEventListener("click", function (e) {
            e.preventDefault();
            const itemId = this.getAttribute("data-item-id");

            axios.post("{% url 'remove_cart_item' %}", { item_id: itemId })
            .then(response => {
                const data = response.data;
                if (data.status === "success") {
                    toastr.success(data.message || "Item removed");
                    const row = document.querySelector(`.cart-row[data-item-id="${itemId}"]`);
                    if (row && row.parentNode) row.parentNode.removeChild(row);
                    
                    const summaryItem = document.querySelector(`.cart-right .summary-item[data-item-id="${itemId}"]`);
                    if (summaryItem && summaryItem.parentNode) summaryItem.parentNode.removeChild(summaryItem);

                    recalcTotals();
                    
                    const remainingRows = document.querySelectorAll(".cart-row");
                    if (remainingRows.length === 0) location.reload();
                } else {
                    toastr.error(data.message || "Something went wrong");
                }
            })
            .catch(error => {
                console.error(error);
                toastr.error("Server error. Try again.");
            });
        });
    });

    // PLUS / MINUS HANDLER
    document.addEventListener("click", function (e) {
        const plusBtn  = e.target.closest(".qty-btn.plus");
        const minusBtn = e.target.closest(".qty-btn.minus");
        if (!plusBtn && !minusBtn) return;

        e.preventDefault();

        const btn    = plusBtn || minusBtn;
        const itemId = btn.getAttribute("data-item-id");
        const row    = document.querySelector(`.cart-row[data-item-id="${itemId}"]`);
        if (!row) return;

        const qtySpan = row.querySelector(".qty-value");
        let currentQty = parseInt(qtySpan.textContent, 10) || 1;
        const delta = plusBtn ? 1 : -1;
        const newQty = currentQty + delta;

        // Get stock directly from DOM (ensures we use latest data)
        const stockAttr = row.getAttribute("data-stock") || "0";
        const stock = parseInt(stockAttr, 10);

        // 1. Prevent going below 1
        if (newQty < 1) return;

        // 2. Logic: Effective Limit (Stock vs User Limit)
        const effectiveLimit = Math.min(stock, USER_LIMIT);

        if (plusBtn) {
            if (newQty > effectiveLimit) {
                // Determine which message to show
                if (stock < USER_LIMIT) {
                    toastr.warning(`Only ${stock} items available in stock.`);
                } else {
                    toastr.warning(`You can only buy up to ${USER_LIMIT} units of this product.`);
                }
                return; // Stop execution
            }
        }

        // Update UI immediately
        qtySpan.textContent = newQty;
        const unitPrice = parseFloat(row.getAttribute("data-price")) || 0;
        const newSubtotal = unitPrice * newQty;

        const rowSubtotalEl = row.querySelector(".cart-subtotal");
        if (rowSubtotalEl) rowSubtotalEl.textContent = formatCurrency(newSubtotal);

        const summaryItem = document.querySelector(`.cart-right .summary-item[data-item-id="${itemId}"]`);
        if (summaryItem) {
            const qtyTextEl = summaryItem.querySelector(".summary-qty");
            const sumSubEl  = summaryItem.querySelector(".summary-subtotal");

            // Safe replace for quantity text
            if (qtyTextEl) {
                let text = qtyTextEl.textContent;
                // Replace number after "Qty:"
                if (text.includes("Qty:")) {
                    qtyTextEl.innerHTML = text.replace(/Qty:\s*\d+/, `Qty: ${newQty}`);
                } else {
                     qtyTextEl.textContent = `Qty: ${newQty}`;
                }
            }
            if (sumSubEl) sumSubEl.textContent = formatCurrency(newSubtotal);
        }

        recalcTotals();

        // Sync with backend
        axios.post("{% url 'update_cart_item_quantity' %}", {
            item_id: itemId,
            quantity: newQty
        })
        .then(response => {
            const data = response.data;
            if (data.status === "success") {
                if (data.cart_total !== undefined) {
                    const leftSubtotal  = document.getElementById("summary-left-subtotal");
                    const rightSubtotal = document.getElementById("summary-right-subtotal");
                    const rightTotal    = document.getElementById("summary-right-total");
                    
                    const fmt = formatCurrency(data.cart_total);
                    if (leftSubtotal)  leftSubtotal.textContent  = fmt;
                    if (rightSubtotal) rightSubtotal.textContent = fmt;
                    if (rightTotal)    rightTotal.textContent    = fmt;
                }
            } else if (data.status === "error") {
                toastr.error(data.message || "Could not update quantity");
                // If backend rejects, reload to sync
                setTimeout(() => location.reload(), 1000);
            }
        })
        .catch(error => {
            console.error(error);
            toastr.error("Server error while updating quantity");
        });
    });

});
</script>
{% endblock extra_script %}