{% extends 'base.html' %}
{% load static %}

{% block title %}Your Cart{% endblock %}

{% block extra_styles %}
<link rel="stylesheet" href="{% static 'css/cart/cart.css' %}">
{% endblock %}

{% block content %}
{% if total_quantity > 0 %}

<div class="cart-container">
    
    <!-- LEFT: CART ITEMS -->
    <div class="cart-left">
        <h2>Your Cart</h2>
        
        <div class="cart-header">
            <span>Product</span>
            <span>Price</span>
            <span>Quantity</span>
            <span>Subtotal</span>
        </div>
        
        {% for item in cartitems %}
        <div class="cart-row" data-item-id="{{ item.id }}">
            
            <!-- PRODUCT -->
            <div class="cart-product">
                <img src="{{ item.variant.product.image.url }}" alt="Product">
                
                <div class="cart-info">
                    <h3>{{ item.variant.product.name }}</h3>
                    <p class="size">Size: {{ item.size }}</p>
                    
                    <a href="#" class="remove" data-item-id="{{ item.id }}">
                        <span>üóëÔ∏è</span> Remove
                    </a>

                </div>
            </div>
            
            <!-- PRICE -->
            <div class="cart-price">
                ‚Çπ{{ item.variant.offer_price }}
                {% if item.variant.base_price %}
                <p><del>‚Çπ{{ item.variant.base_price }}</del></p>
                {% endif %}
            </div>
            
            <!-- QUANTITY -->
            <div class="cart-qty">
                {{ item.quantity }}
            </div>
            
            <!-- SUBTOTAL -->
            <div class="cart-subtotal">
                ‚Çπ{{ item.subtotal }}
            </div>
            
        </div>
        {% endfor %}
        
        <!-- SUMMARY BELOW LEFT SECTION -->
        <div class="cart-summary-left">
            <p>
                <strong>Subtotal:</strong>
                <span id="summary-left-subtotal">‚Çπ{{ total_price }}</span>
            </p>
            <small>Shipping and taxes calculated at checkout</small>
            
            <div class="cart-buttons">
                <a href="#" class="btn-light">Continue Shopping</a>
                <a href="#" class="btn-dark">Proceed to Checkout</a>
            </div>
        </div>
    </div>
    
    <!-- RIGHT: ORDER SUMMARY -->
    <div class="cart-right">
        <h3>Order Summary</h3>
        
        {% for item in cartitems %}
        <div class="summary-item" data-item-id="{{ item.id }}">
            <div>
                <strong>{{ item.variant.product.name }}</strong>
                <p class="summary-qty">Qty: {{ item.quantity }}</p>
            </div>
            <span class="summary-subtotal">‚Çπ{{ item.subtotal }}</span>
        </div>
        {% endfor %}
        
        <hr>
        
        <div class="summary-item">
            <span>Subtotal</span>
            <span id="summary-right-subtotal">‚Çπ{{ total_price }}</span>
        </div>
            
        <hr>
            
        <div class="summary-total">
            <strong>Total</strong>
            <strong id="summary-right-total">‚Çπ{{ total_price }}</strong>
        </div>
    </div>
        
</div>

{% else %}
<div class="cart-empty-container">
    <h2 class="barlow-condensed-semibold">Your Cart</h2>
    <p>Your cart is currently empty.</p>
    
    {% if user.is_authenticated %}
        <a href="{% url 'products_page_user' %}" class="btn-dark">Continue Shopping</a>
    {% else %}
        <a href="{% url 'login' %}" class="btn-dark">Login Continue</a>   
    {% endif %}
</div>
{% endif %}

{% endblock %}

{% block extra_script %}
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>

<script>
document.addEventListener("DOMContentLoaded", function () {

    toastr.options = {
        closeButton: true,
        progressBar: true,
        positionClass: "toast-top-right",
        timeOut: 2000
    };

    // helper to format INR
    function formatCurrency(amount) {
        return "‚Çπ" + Number(amount).toLocaleString("en-IN");
    }

    // recompute totals from remaining rows
    function recalcTotals() {
        const rows = document.querySelectorAll(".cart-row");
        let total = 0;

        rows.forEach(row => {
            const subtotalEl = row.querySelector(".cart-subtotal");
            if (!subtotalEl) return;

            const text = subtotalEl.textContent || "";
            const numeric = text.replace(/[^\d]/g, "");  // keep only digits
            total += parseInt(numeric || "0", 10);
        });

        const leftSubtotal  = document.getElementById("summary-left-subtotal");
        const rightSubtotal = document.getElementById("summary-right-subtotal");
        const rightTotal    = document.getElementById("summary-right-total");

        if (leftSubtotal)  leftSubtotal.textContent  = formatCurrency(total);
        if (rightSubtotal) rightSubtotal.textContent = formatCurrency(total);
        if (rightTotal)    rightTotal.textContent    = formatCurrency(total);
    }

    document.querySelectorAll(".remove").forEach(btn => {

        btn.addEventListener("click", function (e) {
            e.preventDefault();

            const itemId = this.getAttribute("data-item-id");

            axios.post("{% url 'remove_cart_item' %}", {
                item_id: itemId
            })
            .then(response => {
                const data = response.data;

                if (data.status === "success") {
                    toastr.success(data.message || "Item removed");

                    // remove row on left side
                    const row = document.querySelector(`.cart-row[data-item-id="${itemId}"]`);
                    if (row && row.parentNode) {
                        row.parentNode.removeChild(row);
                    }

                    // remove matching item from order summary
                    const summaryItem = document.querySelector(`.cart-right .summary-item[data-item-id="${itemId}"]`);
                    if (summaryItem && summaryItem.parentNode) {
                        summaryItem.parentNode.removeChild(summaryItem);
                    }

                    // recalculate totals
                    recalcTotals();

                    // üî• if no items left, reload so Django shows "empty cart" block
                    const remainingRows = document.querySelectorAll(".cart-row");
                    if (remainingRows.length === 0) {
                        location.reload();
                    }

                } else if (data.status === "error") {
                    toastr.error(data.message || "Something went wrong");

                } else {
                    toastr.error("Unexpected response from server");
                }
            })
            .catch(error => {
                console.error(error);
                toastr.error("Server error. Try again.");
            });

        });

    });

});

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== "") {
        const cookies = document.cookie.split(";");
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + "=")) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

const csrftoken = getCookie("csrftoken");
axios.defaults.headers.common["X-CSRFToken"] = csrftoken;
</script>
{% endblock extra_script %}
