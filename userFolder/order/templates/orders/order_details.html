{% extends 'base.html' %}
{% load static %}

{% block title %}Order Details #{{ order.order_id }}{% endblock %}

{% block extra_styles %}
<link rel="stylesheet" href="{% static "css/order/order_details.css" %}">
<link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
{% endblock extra_styles %}

{% block content %}
<div class="od-wrapper">
    <div class="od-container">
        <a href="{% url 'profile_order' %}" class="back-link">
            <i class='bx bx-left-arrow-alt'></i> Back to Orders
        </a>
        
        <div class="od-header-nav">
            <div class="od-title-row">
                <div class="od-title-left">
                    <h1>Order Details</h1>
                    <div class="od-meta">
                        <span>Order #: {{ order.order_id }}</span>
                        <span>•</span>
                        <span>Placed on: {{ order.created_at|date:"M d, Y" }}</span>
                    </div>
                </div>
                <div>
                    <a href="{% url 'download_invoice' order.order_id %}" class="btn-invoice-outline">
                        <i class='bx bx-file-blank'></i> Download Invoice
                    </a>
                </div>
            </div>
        </div>

        <div class="od-card">
            <h3 class="od-card-title">Order Status</h3>
            
            {% if order.order_status == 'cancelled' or order.order_status == 'partially_cancelled' %}
                <div class="status-header">
                    <div class="status-icon-box" style="background: #fee2e2;">
                        <i class='bx bx-x' style="color: #dc2626;"></i>
                    </div>
                    <div class="status-text">
                        <h3>Order Cancelled</h3>
                        <p>Updated on {{ order.updated_at|date:"M d, Y" }}</p>
                    </div>
                </div>
                <div class="progress-bar-container">
                    <div class="progress-bar-fill" style="width: 100%; background: #dc2626;"></div>
                </div>

            {% elif order.order_status == 'returned' %}
                <div class="status-header">
                    <div class="status-icon-box" style="background: #ffedd5;">
                        <i class='bx bx-revision' style="color: #ea580c;"></i>
                    </div>
                    <div class="status-text">
                        <h3>Returned</h3>
                        <p>Updated on {{ order.updated_at|date:"M d, Y" }}</p>
                    </div>
                </div>
                <div class="progress-bar-container">
                    <div class="progress-bar-fill" style="width: 100%; background: #ea580c;"></div>
                </div>

            {% else %}
                <div class="status-header">
                    <div class="status-icon-box">
                        {% if order.get_progress_status == 4 %}
                            <i class='bx bx-check-double'></i> 
                        {% else %}
                            <i class='bx bx-time-five'></i> 
                        {% endif %}
                    </div>
                    <div class="status-text">
                        <!-- use *_display provided by Django choices -->
                        <h3>{{ order.get_order_status_display }}</h3>
                        
                        {% if order.get_progress_status == 4 %}
                            <p>Delivered on {{ order.updated_at|date:"M d, Y" }}</p>
                        {% else %}
                            <p>Estimated Delivery: 3-5 days</p>
                        {% endif %}
                    </div>
                </div>

                <div class="progress-track">
                    <span>Order Placed</span>
                    <span>Delivered</span>
                </div>
                
                <div class="progress-bar-container">
                    <div class="progress-bar-fill" 
                        style="width: 
                        {% if order.get_progress_status == 0 %}15%
                        {% elif order.get_progress_status == 1 %}40%
                        {% elif order.get_progress_status == 2 %}65%
                        {% elif order.get_progress_status == 3 %}85%
                        {% elif order.get_progress_status == 4 %}100%
                        {% else %}0%{% endif %};">
                    </div>
                </div>
            {% endif %}
        </div>

        <div class="od-card">
            <h3 class="od-card-title">Tracking History</h3>
            
            {% if order.order_status == 'cancelled' %}
                <div class="alert alert-danger" style="color: #dc2626; padding: 10px; background: #fee2e2; border-radius: 6px;">
                    <i class='bx bx-x-circle'></i> This order has been cancelled.
                </div>
            {% elif order.order_status == 'returned' %}
                <div class="alert alert-warning" style="color: #ea580c; padding: 10px; background: #ffedd5; border-radius: 6px;">
                    <i class='bx bx-revision'></i> This order has been returned. <b>Amount Refunded to your wallet</b>
                </div>
            {% else %}
                <div class="timeline">
                    <div class="timeline-item {% if order.get_progress_status >= 0 %}active{% endif %}">
                        <div class="timeline-icon"><i class='bx bx-check'></i></div>
                        <div class="timeline-content"><h4>Order Placed</h4><span>{{ order.created_at|date:"M d, Y" }}</span></div>
                    </div>
                    <div class="timeline-item {% if order.get_progress_status >= 1 %}active{% endif %}">
                        <div class="timeline-icon"><i class='bx {% if order.get_progress_status > 1 %}bx-check{% elif order.get_progress_status == 1 %}bx-loader-alt bx-spin{% else %}bx-cog{% endif %}'></i></div>
                        <div class="timeline-content"><h4>Processing</h4>{% if order.get_progress_status >= 1 %}<span>Confirmed</span>{% endif %}</div>
                    </div>
                    <div class="timeline-item {% if order.get_progress_status >= 2 %}active{% endif %}">
                        <div class="timeline-icon"><i class='bx {% if order.get_progress_status > 2 %}bx-check{% else %}bx-package{% endif %}'></i></div>
                        <div class="timeline-content"><h4>Shipped</h4>{% if order.get_progress_status == 2 %}<span>On the way</span>{% endif %}</div>
                    </div>
                    <div class="timeline-item {% if order.get_progress_status >= 3 %}active{% endif %}">
                        <div class="timeline-icon"><i class='bx {% if order.get_progress_status > 3 %}bx-check{% else %}bx-truck{% endif %}'></i></div>
                        <div class="timeline-content"><h4>Out for Delivery</h4>{% if order.get_progress_status == 3 %}<span>Arriving Today</span>{% endif %}</div>
                    </div>
                    <div class="timeline-item {% if order.get_progress_status >= 4 %}active{% endif %}">
                        <div class="timeline-icon"><i class='bx {% if order.get_progress_status >= 4 %}bx-check{% else %}bx-home-smile{% endif %}'></i></div>
                        <div class="timeline-content"><h4>Delivered</h4>{% if order.get_progress_status >= 4 %}<span>{{ order.updated_at|date:"M d, Y" }}</span>{% endif %}</div>
                    </div>
                    {% if order.has_return_requested %}
                        <div class="timeline-item {% if order.get_progress_status >= -2 %}active{% endif %}">
                            <div class="timeline-icon"><i class='bx {% if order.get_progress_status >= -2 %}bx-check{% else %}bx-home-smile{% endif %}'></i></div>
                            <div class="timeline-content"><h4>Return Requested</h4>{% if order.get_progress_status >= -2 %}<span>{{ order.updated_at|date:"M d, Y" }}</span>{% endif %}</div>
                        </div>
                    {% endif %}
                    
                </div>
            {% endif %}
        </div>

        <div class="od-card">
            <h3 class="od-card-title">Items in Your Order</h3>
            {% for order_item in order.items.all %}
                <div class="item-row">
                    {% with variant=order_item.variant %}
                        {% if variant and variant.product and variant.product.image %}
                            <img src="{{ variant.product.image.url }}" alt="Product" class="item-img">
                        {% else %}
                            <div class="item-img" style="background: #eee;"></div>
                        {% endif %}
                    {% endwith %}
                    
                    <div class="item-details">
                        <span class="item-name">{{ order_item.product_name }}
                            {% if order_item.status != 'pending' %}
                                <span class="badge bg-{{ order_item.get_status_color }}">
                                    {{ order_item.get_status_display }}
                                </span>
                            {% endif %}
                        </span> 
                        
                        <div class="item-meta"> 
                            {% if order_item.variant and order_item.variant.size %}
                                Size: {{ order_item.variant.size }} • 
                            {% endif %}
                            Qty: {{ order_item.quantity }}
                            
                            {% if order_item.items.status == 'returned' %}
                                <span style="color: #ea580c; font-weight: 600; margin-left: 10px;">(Returned)</span>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="item-price-group">
                        {% if order_item.status == 'return_approved' or  order_item.status == 'return_approved' %}
                           <del>
                               <span class="item-unit-price">₹{{ order_item.price_at_purchase }}</span>
                            </del> 
                        {% else %}
                            <span class="item-unit-price">₹{{ order_item.get_total_price }}</span>
                        {% endif %}

                    </div>
                </div>
            {% endfor %}
        </div>

        <div class="address-grid">
            <div class="od-card">
                <h3 class="od-card-title">Shipping Information</h3>
                <div class="address-lines">
                    <strong>{{ order.shipping_address_name }}</strong>
                    {{ order.shipping_address_line_1 }}<br>
                    {{ order.shipping_city }} - {{ order.shipping_pincode }}<br>
                    {{ order.shipping_state }}<br>
                    Phone: {{ order.shipping_phone }}
                </div>
            </div>

            <div class="od-card">
                <h3 class="od-card-title">Payment Details</h3>
                <div class="address-lines">
                    <strong>Billing same as shipping</strong>
                </div>
                <div class="payment-info">
                    <span class="payment-label">Method</span>
                    <span class="payment-value">{{ order.get_payment_method_display|default:"Not Selected" }}</span>
                    <br>
                    <span class="payment-label">Status</span>
                    <span class="payment-value">
                        {% if order.payment_status == 'paid' %}
                            <span style="color: #10b981;">Paid</span>
                        {% elif order.payment_status == 'failed' %}
                            <span style="color: #dc2626;">Failed</span>
                        {% else %}
                            <span style="color: #f59e0b;">{{ order.get_payment_status_display }}</span>
                        {% endif %}
                    </span>
                </div>
            </div>
        </div>
        <br>

        <div class="od-card order-summary-card">
            <h3 class="od-card-title">Order Summary</h3>
            <div class="summary-row"><span>Subtotal</span><span>₹{{ order.total_price }}</span></div>
            <div class="summary-row"><span>Shipping</span><span>+₹{{order.shipping_amount}}</span></div>
            <div class="summary-row"><span>Discount</span><span style="color: #10b981;">-₹{{ order.discount_amount }}</span></div>
            {% if order.wallet_deduction %}
                <div class="summary-row"><span>Wallet Deduction</span><span style="color: #10b981;">-₹{{ order.wallet_deduction }}</span></div>
            {% endif %}
            {% if coupon_discount %}
                <div class="summary-row"><span>Coupon Deduction</span><span style="color: #10b981;">-₹{{ order.coupon_discount }}</span></div>
            {% endif %}
            <div class="summary-row total"><span>Total</span><span>₹{{ order.final_price }}</span></div>
        </div>

        {% if order.order_status != 'cancelled' and order.order_status != 'returned' %}
            <div class="od-bottom-actions">
                {% if order.has_return_requested or order.order_status == 'return_rejected'%}
                    <a href="{% url 'cancel_return_order_view' order.order_id %}">
                        <button type='button' class="btn-action btn-return-cancel"> 
                            <i class='bx bx-x-circle'></i> 
                            Cancel Return
                        </button>
                    </a>
                {% elif order.order_status == 'delivered' and order.payment_status == 'paid' %}
                    {% if not order.is_return_period_expired %}
                        <div class="action-note">
                            <p>Need to return items? You can request a return within 7 days.</p>
                        </div>
                        <button onclick="openReturnModal()" type="button" class="btn-action btn-return-full">
                            <i class='bx bx-revision'></i> Return Items / Order
                        </button>
                    {% else %}
                        <div class="action-note">
                            <p style="color: #dc2626;">Return period expired (7 days passed).</p>
                        </div>
                        <button type="button" class="btn-action btn-disabled" disabled>
                            Return Window Closed
                        </button>
                    {% endif %}

                {% elif order.order_status == 'pending' or order.order_status == 'confirmed' or order.order_status == 'processing' %}
                    <button type="button" onclick="openCancelOrderModal()" class="btn-action btn-cancel-full">
                        <i class='bx bx-x-circle'></i>Cancel Order
                    </button>
                {% endif %}

            </div>
        {% endif %}

    </div>
</div>

<div id="returnModal" class="custom-modal">
    <div class="custom-modal-content">
        <div class="modal-header">
            <h3>Request Return</h3>
            <span class="close-modal" onclick="closeReturnModal()">&times;</span>
        </div>
        
        <form action="{% url 'return_order_view' order.order_id %}" method="POST" id="returnForm">
            {% csrf_token %}
            
            <input type="hidden" id="return_mode" name="return_mode" value="individual">

            <div class="modal-body">
                <div class="return-tabs">
                    <button type="button" class="tab-btn active" onclick="setReturnMode('individual', this)">
                        Select Items
                    </button>
                    <button type="button" class="tab-btn" onclick="setReturnMode('all', this)">
                        Return Entire Order
                    </button>
                </div>

                <div id="global_reason_section" style="display: none; margin-bottom: 20px;">
                    <div class="alert-box">
                        <i class='bx bx-info-circle'></i> All eligible items in this order will be returned.
                    </div>
                    <div class="form-group">
                        <label>Reason for Returning Entire Order:</label>
                        <select id="global_reason" class="form-select">
                            <option value="" selected disabled>Select a reason...</option>
                            <option value="damaged">Package Damaged</option>
                            <option value="wrong_item">Received Wrong Order</option>
                            <option value="quality">Quality Issues</option>
                            <option value="changed_mind">Changed Mind</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Additional Comments:</label>
                        <textarea id="global_note" class="form-input" rows="2" placeholder="Describe the issue..."></textarea>
                    </div>
                </div>

                <p class="modal-subtitle" id="list_subtitle">Select the items you wish to return and provide a reason for each.</p>
                
                <div class="return-items-list">
                    {% for item in order.items.all %}
                        {% if item.status != 'returned' and item.status != 'cancelled' %}
                        <div class="return-item-row" id="row_{{ item.id }}">
                            
                            <div class="return-checkbox-group">
                                <input type="checkbox" 
                                       id="check_{{ item.id }}" 
                                       name="selected_items" 
                                       value="{{ item.id }}" 
                                       class="item-checkbox"
                                       onchange="toggleReturnReason('{{ item.id }}')">
                                
                                <label for="check_{{ item.id }}" class="item-label">
                                    {% with variant=item.variant %}
                                        {% if variant and variant.product and variant.product.image %}
                                            <img src="{{ variant.product.image.url }}" alt="img" class="sm-thumb">
                                        {% else %}
                                            <div class="sm-thumb" style="background: #eee;"></div>
                                        {% endif %}
                                    {% endwith %}
                                    <div class="sm-info">
                                        <span class="sm-name">{{ item.product_name }}</span>
                                        <span class="sm-meta">
                                            {% if item.variant and item.variant.size %}
                                                Size: {{ item.variant.size }} |
                                            {% endif %}
                                            Qty: {{ item.quantity }}
                                        </span>
                                    </div>
                                    <span class="sm-price">₹{{ item.price_at_purchase }}</span>
                                </label>
                            </div>

                            <div id="reason_container_{{ item.id }}" class="return-reason-box" style="display: none;">
                                <div class="form-group">
                                    <label>Reason:</label>
                                    <select name="reason_{{ item.id }}" id="reason_input_{{ item.id }}" class="form-select" disabled>
                                        <option value="" selected disabled>Select...</option>
                                        <option value="damaged">Damaged</option>
                                        <option value="wrong_item">Wrong Item</option>
                                        <option value="size_issue">Size Issue</option>
                                        <option value="quality">Quality</option>
                                        <option value="changed_mind">Changed Mind</option>
                                        <option value="other">Other</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <textarea name="note_{{ item.id }}" id="note_input_{{ item.id }}" class="form-input" rows="1" placeholder="Describe the issue..." disabled></textarea>
                                </div>
                            </div>
                            
                            <input type="hidden" name="hidden_reason_{{ item.id }}" id="hidden_reason_{{ item.id }}">
                            <input type="hidden" name="hidden_note_{{ item.id }}" id="hidden_note_{{ item.id }}">

                        </div>
                        {% endif %}
                    {% endfor %}
                </div>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn-cancel-modal" onclick="closeReturnModal()">Cancel</button>
                <button type="submit" class="btn-confirm-modal">Submit Request</button>
            </div>
        </form>
    </div>
</div>

<div id="cancelOrderModal" class="custom-modal">
    <div class="custom-modal-content">
        <div class="modal-header">
            <h3>Cancel Items</h3>
            <span class="close-modal" onclick="closeCancelOrderModal()">&times;</span>
        </div>

        <form action="{% url 'cancel_order_view' order.order_id %}" method="POST" id="cancelOrderForm">
            {% csrf_token %}
            <input type="hidden" id="cancel_mode" name="cancel_mode" value="individual">

            <div class="modal-body">

                <!-- Tabs -->
                <div class="return-tabs">
                    <button type="button" class="tab-btn active"
                            onclick="setCancelMode('individual', this)">
                        Select Items
                    </button>

                    <button type="button" class="tab-btn"
                            onclick="setCancelMode('all', this)">
                        Cancel Entire Order
                    </button>
                </div>

                <div id="cancel_list_subtitle" class="modal-subtitle">
                    Check the items you want to cancel and provide details.
                </div>

                <!-- Item List -->
                <div class="return-items-list">
                    {% for item in order.items.all %}
                        {% if item.status != 'returned' and item.status != 'cancelled' %}
                        <div class="return-item-row" id="cancel_row_{{ item.id }}">

                            <div class="return-checkbox-group">
                               <input type="checkbox"
                                        id="cancel_check_{{ item.id }}"
                                        name="selected_items"  value="{{ item.id }}"
                                        class="item-checkbox"
                                        onchange="toggleCancelInput('{{ item.id }}')">

                                <label for="cancel_check_{{ item.id }}" class="item-label">
                                    <img src="{{ item.variant.product.image.url }}" class="sm-thumb">
                                    <div class="sm-info">
                                        <span class="sm-name">{{ item.product_name }}</span>
                                        <span class="sm-meta">
                                            Qty: {{ item.quantity }} | ₹{{ item.price_at_purchase }}
                                        </span>
                                    </div>
                                </label>
                            </div>

                            <div id="cancel_input_container_{{ item.id }}"
                                 class="return-reason-box"
                                 style="display:none; margin-top:10px; padding-left:35px;">

                                <div class="form-group">
                                    <select id="cancel_reason_{{ item.id }}"
                                            class="form-select"
                                            disabled>
                                        <option value="" selected disabled>Select Reason</option>
                                        <option value="wrong_item">Ordered by mistake</option>
                                        <option value="delivery_time">Delivery taking too long</option>
                                        <option value="price">Found better price</option>
                                        <option value="other">Other</option>
                                    </select>
                                </div>

                                <div class="form-group">
                                    <textarea id="cancel_note_{{ item.id }}"
                                              class="form-input"
                                              rows="1"
                                              placeholder="Write description (Required)..."
                                              disabled></textarea>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                    {% endfor %}
                </div>

                <!-- Full Order Cancel -->
                <div id="cancel_global_section" style="display:none;">
                    <div class="form-group">
                        <label>Reason for Full Cancellation</label>
                        <select id="cancel_global_reason" class="form-select">
                            <option value="" disabled selected>Select Reason</option>
                            <option value="changed_mind">Changed Mind</option>
                            <option value="other">Other</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <textarea id="cancel_global_note"
                                  class="form-input"
                                  rows="2"
                                  placeholder="Description (Required)..."></textarea>
                    </div>
                </div>

            </div>

            <div class="modal-footer">
                <button type="button" class="btn-cancel-modal" onclick="closeCancelOrderModal()">Close</button>
                <button type="submit" class="btn-confirm-modal">Confirm Cancellation</button>
            </div>
        </form>
    </div>
</div>


<div id="cancelReturnModal" class="custom-modal">
    <div class="custom-modal-content modal-sm">
        <div class="modal-header">
            <h3>Cancel Return Request</h3>
            <span class="close-modal" onclick="closeCancelReturnModal()">&times;</span>
        </div>
        
        <div class="modal-body" style="text-align: center; padding: 30px 20px;">
            <i class='bx bx-question-mark' style="font-size: 50px; color: #f59e0b; margin-bottom: 15px;"></i>
            <p style="font-size: 16px; color: #444;">Are you sure you want to cancel your return request? <br>You can re-apply if the 7-day window is still open.</p>
        </div>

        <div class="modal-footer" style="justify-content: center;">
            <button type="button" class="btn-cancel-modal" onclick="closeCancelReturnModal()">No, Keep it</button>
            <a href="{% url 'cancel_return_order_view' order.order_id %}" class="btn-confirm-modal" style="text-decoration: none;">
                Yes, Cancel Return
            </a>
        </div>
    </div>
</div>

{% endblock content %}

{% block extra_script %}
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script src="{% static "js/order/order.js" %}"></script>
{% endblock extra_script %}
