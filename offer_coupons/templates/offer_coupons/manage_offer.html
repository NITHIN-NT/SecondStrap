{% extends "adminbase.html" %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/offer_coupons/manage_offer.css' %}">
{% endblock extra_css %}

{% block content %}
<a href="{% url 'offers_view' %}" class="btn-back">‚Üê Back to Offers</a>

<div class="offer-desktop-wrapper">
<div class="offer-card">

    <div class="offer-header">
        <h2>Create New Offer</h2>
    </div>

    <form method="post" id="offerForm" onsubmit="attachSelected()">
        {% csrf_token %}

        <!-- GLOBAL ERRORS -->
        {% if form.non_field_errors %}
            <div class="form-errors">
                {{ form.non_field_errors }}
            </div>
        {% endif %}

        <!-- BASIC INFO -->
        <div class="form-grid">

            <div class="form-group">
                {% if form.errors.name %}
                    <div class="field-error">{{ form.errors.name|striptags }}</div>
                {% endif %}
                <label>Offer Name</label>
                
                <input type="text" name="name"
                       value="{{ form.name.value|default_if_none:'' }}">
            </div>

            <div class="form-group">
                {% if form.errors.code %}
                    <div class="field-error">{{ form.errors.code|striptags }}</div>
                {% endif %}
                <label>Coupon Code</label>
                <input type="text" name="code"
                       value="{{ form.code.value|default_if_none:'' }}">
            </div>

            <div class="form-group">
                {% if form.errors.offer_type %}
                    <div class="field-error">{{ form.errors.offer_type|striptags }}</div>
                {% endif %}
                <label>Offer Type</label>
                <select name="offer_type" id="offerType">
                    <option value="">-- Select --</option>
                    <option value="product" {% if form.offer_type.value == "product" %}selected{% endif %}>Product Offer</option>
                    <option value="category" {% if form.offer_type.value == "category" %}selected{% endif %}>Category Offer</option>
                    <option value="amount_threshold" {% if form.offer_type.value == "amount_threshold" %}selected{% endif %}>Order Amount Offer</option>
                </select>
            </div>

            <div class="form-group">
                 {% if form.errors.discount_type %}
                    <div class="field-error">{{ form.errors.discount_type|striptags }}</div>
                {% endif %}
                <label>Discount Type</label>
                <select name="discount_type">
                    <option value="percentage" {% if form.discount_type.value == "percentage" %}selected{% endif %}>Percentage</option>
                    <option value="fixed_amount" {% if form.discount_type.value == "fixed_amount" %}selected{% endif %}>Fixed Amount</option>
                </select>
            </div>

        </div>

        <!-- PRODUCT SEARCH -->
        <div id="productSection" class="conditional-section">
            {% if form.errors.products %}
                <div class="field-error">{{ form.errors.products|striptags }}</div>
            {% endif %}
            <label>Search Products</label>
            <input type="text" id="productSearch" placeholder="Type product name...">
            <ul id="productResults" class="search-results"></ul>

            <h4>Selected Products</h4>
            <ul id="selectedProducts"></ul>
        </div>

        <!-- CATEGORY SEARCH -->
        <div id="categorySection" class="conditional-section">
            {% if form.errors.categories %}
                <div class="field-error">{{ form.errors.categories|striptags }}</div>
            {% endif %}
            <label>Search Categories</label>
            <input type="text" id="categorySearch" placeholder="Type category name...">
            <ul id="categoryResults" class="search-results"></ul>

            <h4>Selected Categories</h4>
            <ul id="selectedCategories"></ul>
        </div>

        <!-- ORDER AMOUNT -->
        <div id="amountSection" class="conditional-section">
            <div class="form-group">
                {% if form.errors.min_order_amount %}
                    <div class="field-error">{{ form.errors.min_order_amount|striptags }}</div>
                {% endif %}
                <label>Minimum Order Amount</label>
                <input type="number" name="min_order_amount" step="0.01"
                       value="{{ form.min_order_amount.value|default_if_none:'' }}">
            </div>
        </div>

        <!-- DISCOUNT -->
        <div class="form-grid">

            <div class="form-group">
                {% if form.errors.discount_value %}
                    <div class="field-error">{{ form.errors.discount_value|striptags }}</div>
                {% endif %}
                <label>Discount Value</label>
                <input type="number" name="discount_value" step="0.01"
                       value="{{ form.discount_value.value|default_if_none:'' }}">
            </div>

            <div class="form-group">
                {% if form.errors.usage_limit %}
                    <div class="field-error">{{ form.errors.usage_limit|striptags }}</div>
                {% endif %}
                <label>Usage Limit</label>
                <input type="number" name="usage_limit"
                       value="{{ form.usage_limit.value|default:0 }}">
            </div>

            <div class="form-group">
                {% if form.errors.per_user_limit %}
                    <div class="field-error">{{ form.errors.per_user_limit|striptags }}</div>
                {% endif %}
                <label>Per User Limit</label>
                <input type="number" name="per_user_limit"
                       value="{{ form.per_user_limit.value|default:1 }}">
            </div>

        </div>

        <!-- DATES -->
        <div class="form-grid">

            <div class="form-group">
                {% if form.errors.start_date %}
                    <div class="field-error">{{ form.errors.start_date|striptags }}</div>
                {% endif %}
                <label>Start Date</label>
                <input type="datetime-local" name="start_date"
                       value="{{ form.start_date.value|default_if_none:'' }}">
            </div>

            <div class="form-group">
                {% if form.errors.end_date %}
                    <div class="field-error">{{ form.errors.end_date|striptags }}</div>
                {% endif %}
                 <label>End Date</label>
                <input type="datetime-local" name="end_date"
                       value="{{ form.end_date.value|default_if_none:'' }}">
            </div>

        </div>

        <!-- DESCRIPTION -->
        <div class="form-group full-width">
            {% if form.errors.description %}
                <div class="field-error">{{ form.errors.description|striptags }}</div>
            {% endif %}
            <label>Description</label>
            <textarea name="description">{{ form.description.value|default_if_none:'' }}</textarea>
        </div>

        <br>

        <!-- HIDDEN FIELDS -->
        <input type="hidden" name="products" id="productsInput">
        <input type="hidden" name="categories" id="categoriesInput">

        <button type="submit" class="btn-primary">Save Offer</button>

    </form>
</div>
</div>
{% endblock %}

{% block extraJs %}
<script>
    window.PRODUCT_SEARCH_URL = "{% url 'search_products' %}";
    window.CATEGORY_SEARCH_URL = "{% url 'search_categories' %}";
</script>

<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script src="{% static 'js/offer_coupons/manage_offer.js' %}"></script>
{% endblock %}
