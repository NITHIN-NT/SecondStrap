{% extends "adminbase.html" %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/offer_coupons/offer_coupons.css' %}">
{% endblock extra_css %}

{% block content %}
<div class="offers-page-container">

    <div class="offers-card">

        <!-- Sticky Header -->
        <div class="offers-sticky-header">
            <div class="offers-header">
                <h1>Offers & Promotions</h1>
                <p>Manage discounts and promotional offers</p>
            </div>

            <div class="card-header-main">
                <a href="{% url 'manage_offer_view' %}" class="create-offer-link">
                    <button type="button" class="create-offer-btn">
                        <i class="fa-solid fa-plus"></i>
                        <span>Create Offer</span>
                    </button>
                </a>
            </div>
        </div>

        <!-- Table -->
        <div class="table-responsive">
            <table class="offers-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Offer Name</th>
                        <th>Description</th>
                        <th>Code</th>
                        <th>Offer Type</th>
                        <th>Discount Type</th>
                        <th>Discount</th>
                        <th>Valid Period</th>
                        <th class="text-center">Limit</th>
                        <th class="text-center">Per user Limit</th>
                        <th>Status</th>
                        <th>Display</th>
                        <th class="text-center">Actions</th>
                    </tr>
                </thead>

                <tbody>
                    {% for offer in offers %}
                    <tr>
                        <td>{{ offer.id }}</td>
                        <td>{{ offer.name }}</td>
                        <td>{{offer.description}}</td>
                        <td>{{ offer.code }}</td>

                        <!-- TextChoices Display -->
                        <td>{{ offer.get_offer_type_display }}</td>
                        <td>{{ offer.get_discount_type_display }}</td>

                        <!-- Discount Formatting -->
                        <td>
                            {% if offer.discount_type == "percentage" %}
                                {{ offer.discount_value }}%
                            {% else %}
                                ₹{{ offer.discount_value }}
                            {% endif %}
                        </td>

                        <!-- Date Range -->
                        <td>
                            {{ offer.start_date|date:"Y-m-d" }}
                            →
                            {{ offer.end_date|date:"Y-m-d" }}
                        </td>

                        <td class="text-center">{{ offer.usage_limit }}</td>
                        <td class="text-center">{{offer.per_user_limit}}</td>

                        <!-- Status -->
                        <td>
                            {% if offer.active %}
                                <span class="status-badge active">Active</span>
                            {% else %}
                                <span class="status-badge inactive">Inactive</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if offer.display_home %}
                                <span class="status-badge active">Displayed on Home</span>
                            {% else %}
                                <span class="status-badge inactive">Hidden</span>
                            {% endif %}
                        </td>
                        <!-- Actions -->
                        <td class="action-buttons text-center">
                            <a href="{% url "Offer_detailed_view" offer.id %}" class="action-btn view-btn" title="View">
                                <i class="fa-solid fa-file-lines"></i>View
                            </a>

                            <a href="#" class="action-btn edit-btn" title="Edit">
                                <i class="fa-solid fa-pen-to-square"></i>Edit
                            </a>

                            <a href="#" 
                                class="action-btn delete-btn" 
                                onclick="showDeleteModal(event, {{ offer.id }})">
                                    <i class="fa-solid fa-trash-can"></i> Delete
                            </a>
                        </td>
                    </tr>

                    {% empty %}
                    <tr>
                        <td colspan="14" class="text-center">
                            No offers available.
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>

                <tfoot>
                    <tr>
                        <td colspan="14" class="footer-count">
                            Total Active Offers: {{ total_active_offers }}
                        </td>
                    </tr>
                </tfoot>
            </table>
        </div>

        <!-- Pagination -->
        {% if page_obj %}
        <div class="offers-pagination">
            <div class="pagination-info">
                Showing {{ page_obj.start_index }} to {{ page_obj.end_index }}
                of {{ page_obj.paginator.count }} results
            </div>

            <div class="pagination-controls">
                {% if page_obj.has_previous %}
                    <a href="?page={{ page_obj.previous_page_number }}" class="pagination-btn">
                        <i class="fa-solid fa-chevron-left"></i>
                    </a>
                {% else %}
                    <button class="pagination-btn disabled">
                        <i class="fa-solid fa-chevron-left"></i>
                    </button>
                {% endif %}

                {% for num in page_obj.paginator.page_range %}
                    {% if page_obj.number == num %}
                        <button class="pagination-page active">{{ num }}</button>
                    {% else %}
                        <a href="?page={{ num }}" class="pagination-page">{{ num }}</a>
                    {% endif %}
                {% endfor %}

                {% if page_obj.has_next %}
                    <a href="?page={{ page_obj.next_page_number }}" class="pagination-btn">
                        <i class="fa-solid fa-chevron-right"></i>
                    </a>
                {% else %}
                    <button class="pagination-btn disabled">
                        <i class="fa-solid fa-chevron-right"></i>
                    </button>
                {% endif %}
            </div>
        </div>
        {% endif %}

    </div>
</div>
<div id="deleteModal" class="modal-overlay">
    <div class="modal-content">
        <h3>Confirm Deletion</h3>
        <p>Are you sure you want to delete this offer?</p>
        <div class="modal-actions">
            <button onclick="closeModal()" class="btn-secondary">Cancel</button>
            <button id="confirmDeleteBtn" class="btn-danger">Delete Permanently</button>
        </div>
    </div>
</div>
{% endblock content %}
{% block extraJs %}
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>

<script>
// 1. Toastr Configuration
toastr.options = {
    "closeButton": true,
    "progressBar": true,
    "positionClass": "toast-top-right",
    "timeOut": "2000",
};

// 2. Configure Axios to handle CSRF automatically for all requests
axios.defaults.xsrfCookieName = 'csrftoken';
axios.defaults.xsrfHeaderName = 'X-CSRFToken';
axios.defaults.headers.common['X-Requested-With'] = 'XMLHttpRequest';

function closeModal() {
    document.getElementById('deleteModal').style.display = 'none';
}

function showDeleteModal(event, offerId) {
    event.preventDefault();
    const modal = document.getElementById('deleteModal');
    const confirmBtn = document.getElementById('confirmDeleteBtn');
    modal.style.display = 'flex';
    
    // Assign the click event to call executeDelete with the ID
    confirmBtn.onclick = function() { executeDelete(offerId); };
}

function executeDelete(offerId) {
    axios.post('{% url "Offer_delete_view" %}', {
        id: offerId
    })
    .then(response => {
        if (response.data.status === "success") {
            toastr.success(response.data.message);
            closeModal();

            // Find the specific row by searching the ID column
            // We look for the <td> that exactly matches the offerId
            $('table.offers-table tbody tr').each(function() {
                const firstColText = $(this).find('td:first').text().trim();
                if (firstColText == offerId) {
                    $(this).fadeOut(500, function() { 
                        $(this).remove(); 
                        
                        // Optional: Refresh if table is empty to show "No offers available"
                        if ($('table.offers-table tbody tr').length === 0) {
                            window.location.reload();
                        }
                    });
                }
            });
        } else {
            toastr.error(response.data.message || 'Error deleting offer.');
        }
    })
    .catch(error => {
        toastr.error('An error occurred on the server.');
        console.error('Delete Error:', error);
        closeModal();
    });
}
</script>
{% endblock extraJs %}


